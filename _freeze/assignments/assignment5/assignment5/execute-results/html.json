{
  "hash": "11a507c6c4e0c55f25a5a259f2ee8bd9",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"HW5: Bike Share Demand Prediction - Q3 2024\"\nsubtitle: \"Complete Space-Time Analysis\"\nauthor: \"Zicheng Xiang, Zhe Fang\"\ndate: 2025.11.30\nformat:\n  html:\n    toc: true\n    toc-depth: 3\n    code-fold: show\n    theme: cosmo\n    self-contained: true\nexecute:\n  warning: false\n  message: false\n---\n\n# Setup\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(lubridate)\nlibrary(sf)\nlibrary(tigris)\nlibrary(tidycensus)\nlibrary(riem)\nlibrary(viridis)\nlibrary(knitr)\nlibrary(kableExtra)\nlibrary(MASS)\nlibrary(zoo)\nlibrary(glue)\noptions(scipen = 999)\n\n# Plot themes\nplotTheme <- theme(\n  plot.title = element_text(size = 14, face = \"bold\"),\n  plot.subtitle = element_text(size = 10),\n  axis.title = element_text(size = 10, face = \"bold\"),\n  axis.text = element_text(size = 9),\n  legend.position = \"right\"\n)\n\nmapTheme <- theme(\n  plot.title = element_text(size = 14, face = \"bold\"),\n  axis.line = element_blank(),\n  axis.text = element_blank(),\n  axis.ticks = element_blank(),\n  axis.title = element_blank(),\n  panel.background = element_blank(),\n  legend.position = \"right\"\n)\n```\n:::\n\n\n---\n\n# Part 1: Data Loading\n\n## Load Indego Trip Data (Q3 2024)\n\n**Selected Quarter:** Q3 2024 (July - September)\n\n**Why Q3 2024?**\n\nI chose Q3 2024 (July-September) because:\n1. Summer represents peak biking season with highest ridership\n2. Provides contrast to Q1 winter data (different weather patterns)\n3. Includes major holidays (July 4th, Labor Day) to test holiday effects\n4. Warm weather reduces weather-related variability, making other factors more visible\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Read Q3 2024 data\nindego_hw <- read_csv(\"data/indego-trips-2024-q3.csv\")\n\nglue(\"Total trips in Q3 2024: {format(nrow(indego_hw), big.mark = ',')}\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nTotal trips in Q3 2024: 408,408\n```\n\n\n:::\n\n```{.r .cell-code}\nglue(\"Date range: {min(mdy_hm(indego_hw$start_time))} to {max(mdy_hm(indego_hw$start_time))}\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nDate range: 2024-07-01 00:02:00 to 2024-09-30 23:59:00\n```\n\n\n:::\n:::\n\n\n## Create Time Features\n\n\n::: {.cell}\n\n```{.r .cell-code}\nindego_hw <- indego_hw %>%\n  mutate(\n    start_datetime = mdy_hm(start_time),\n    end_datetime = mdy_hm(end_time),\n    interval60 = floor_date(start_datetime, unit = \"hour\"),\n    week = week(interval60),\n    month = month(interval60, label = TRUE),\n    dotw = wday(interval60, label = TRUE),\n    hour = hour(interval60),\n    date = as.Date(interval60),\n    weekend = ifelse(dotw %in% c(\"Sat\", \"Sun\"), 1, 0),\n    rush_hour = ifelse(hour %in% c(7, 8, 9, 16, 17, 18), 1, 0)\n  )\n\nglue(\"Time features created successfully!\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nTime features created successfully!\n```\n\n\n:::\n:::\n\n\n## Get Weather Data\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Get Q3 2024 weather from Philadelphia Airport\nweather_hw <- riem_measures(\n  station = \"PHL\",\n  date_start = \"2024-07-01\",\n  date_end = \"2024-09-30\"\n)\n\n# Process weather\nweather_processed_hw <- weather_hw %>%\n  dplyr::mutate(\n    interval60 = floor_date(valid, unit = \"hour\"),\n    Temperature = tmpf,\n    Precipitation = ifelse(is.na(p01i), 0, p01i),\n    Wind_Speed = sknt\n  ) %>%\n  dplyr::select(interval60, Temperature, Precipitation, Wind_Speed) %>%\n  dplyr::distinct()\n\n# Fill missing hours\nweather_complete_hw <- weather_processed_hw %>%\n  complete(interval60 = seq(min(interval60), max(interval60), by = \"hour\")) %>%\n  fill(Temperature, Precipitation, Wind_Speed, .direction = \"down\")\n\nglue(\"Weather data downloaded successfully!\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nWeather data downloaded successfully!\n```\n\n\n:::\n\n```{.r .cell-code}\nglue(\n  \"Temperature range: {round(min(weather_complete_hw$Temperature, na.rm = TRUE), 1)} \",\n  \"to {round(max(weather_complete_hw$Temperature, na.rm = TRUE), 1)} °F\"\n)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nTemperature range: 55 to 98 °F\n```\n\n\n:::\n:::\n\n\n## Get Census Data\n\n::: {.cell}\n\n```{.r .cell-code}\n# Get Philadelphia census tracts\nphilly_census_hw <- get_acs(\n  geography = \"tract\",\n  variables = c(\n    \"B01003_001\",  # Total population\n    \"B19013_001\",  # Median household income\n    \"B08301_001\",  # Total commuters\n    \"B08301_010\",  # Commute by transit\n    \"B02001_002\"   # White alone\n  ),\n  state = \"PA\",\n  county = \"Philadelphia\",\n  year = 2022,\n  geometry = TRUE,\n  output = \"wide\"\n) %>%\n  rename(\n    Total_Pop = B01003_001E,\n    Med_Inc = B19013_001E,\n    Total_Commuters = B08301_001E,\n    Transit_Commuters = B08301_010E,\n    White_Pop = B02001_002E\n  ) %>%\n  mutate(\n    Percent_Taking_Public_Trans = (Transit_Commuters / Total_Commuters) * 100,\n    Percent_White = (White_Pop / Total_Pop) * 100\n  ) %>%\n  st_transform(crs = 4326) %>%\n  st_buffer(0)  # FIX: Repair invalid geometries\n\nglue(\"Census data downloaded successfully!\")\n```\n:::\n\n\n## Join Census to Stations\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Get unique stations as sf object\nstations_sf_hw <- indego_hw %>%\n  distinct(start_station, start_lat, start_lon) %>%\n  filter(!is.na(start_lat), !is.na(start_lon), !is.na(start_station)) %>%\n  mutate(start_station = as.character(start_station)) %>%\n  st_as_sf(coords = c(\"start_lon\", \"start_lat\"), crs = 4326)\n\n# Spatial join\nstations_census_hw <- st_join(stations_sf_hw, philly_census_hw, left = TRUE) %>%\n  st_drop_geometry()\n\n# Filter to valid stations\nvalid_stations_hw <- stations_census_hw %>%\n  filter(!is.na(Med_Inc)) %>%\n  pull(start_station)\n\n# Join to trip data\nindego_census_hw <- indego_hw %>%\n  filter(!is.na(start_station)) %>%\n  mutate(start_station = as.character(start_station)) %>%\n  filter(start_station %in% valid_stations_hw) %>%\n  left_join(\n  stations_census_hw,\n  by = \"start_station\"\n)\n\nglue(\"Stations with census data: {length(valid_stations_hw)}\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nStations with census data: 250\n```\n\n\n:::\n\n```{.r .cell-code}\nglue(\"Trips successfully joined: {format(nrow(indego_census_hw), big.mark = ',')}\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nTrips successfully joined: 404,282\n```\n\n\n:::\n:::\n\n\n## Create Station-Hour Panel\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Aggregate to station-hour\nride_hw <- indego_census_hw %>%\n  group_by(start_station, interval60, start_lat, start_lon,\n           Med_Inc, Percent_Taking_Public_Trans, Percent_White, Total_Pop) %>%\n  summarize(Trip_Count = n(), .groups = \"drop\") %>%\n  mutate(\n    week = week(interval60),\n    month = month(interval60, label = TRUE),\n    dotw = wday(interval60, label = TRUE),\n    dotw_simple = ifelse(dotw %in% c(\"Sat\", \"Sun\"), \"Weekend\", \"Weekday\"),\n    hour = hour(interval60),\n    date = as.Date(interval60),\n    weekend = ifelse(dotw %in% c(\"Sat\", \"Sun\"), 1, 0),\n    rush_hour = ifelse(hour %in% c(7, 8, 9, 16, 17, 18), 1, 0)\n  )\n\n# Join weather\nride_hw <- ride_hw %>%\n  left_join(weather_complete_hw, by = \"interval60\")\n\nglue(\"Panel observations: {format(nrow(ride_hw), big.mark = ',')}\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nPanel observations: 245,733\n```\n\n\n:::\n:::\n\n\n## Create Temporal Lags\n\n\n::: {.cell}\n\n```{.r .cell-code}\nride_hw <- ride_hw %>%\n  arrange(start_station, interval60) %>%\n  group_by(start_station) %>%\n  mutate(\n    lag1Hour = lag(Trip_Count, 1),\n    lag3Hours = lag(Trip_Count, 3),\n    lag1day = lag(Trip_Count, 24)\n  ) %>%\n  ungroup()\n\nglue(\"Temporal lags created!\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nTemporal lags created!\n```\n\n\n:::\n:::\n\n\n## Train/Test Split\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# FIX: Remove NA from lags BEFORE splitting\nride_hw_clean <- ride_hw %>%\n  filter(!is.na(lag1Hour), !is.na(lag3Hours), !is.na(lag1day))\n\n# Split: 70% train, 30% test by date\nset.seed(123)\ntrain_dates_hw <- sample(unique(ride_hw_clean$date), \n                         size = round(length(unique(ride_hw_clean$date)) * 0.7))\n\ntrain_hw <- ride_hw_clean %>%\n  filter(date %in% train_dates_hw)\n\ntest_hw <- ride_hw_clean %>%\n  filter(!date %in% train_dates_hw)\n\nglue(\"Training obs: {format(nrow(train_hw), big.mark = ',')}\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nTraining obs: 165,571\n```\n\n\n:::\n\n```{.r .cell-code}\nglue(\"Testing obs: {format(nrow(test_hw), big.mark = ',')}\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nTesting obs: 74,354\n```\n\n\n:::\n\n```{.r .cell-code}\nglue(\"Training dates: {length(unique(train_hw$date))}\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nTraining dates: 64\n```\n\n\n:::\n\n```{.r .cell-code}\nglue(\"Testing dates: {length(unique(test_hw$date))}\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nTesting dates: 28\n```\n\n\n:::\n:::\n\n\n---\n\n# Part 1: Build Models 1-5\n\n## Model 1: Time + Weather\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmodel1_hw <- lm(\n  Trip_Count ~ hour + Temperature + Precipitation + weekend,\n  data = train_hw\n)\n\ntest_hw <- test_hw %>%\n  mutate(pred1 = predict(model1_hw, newdata = test_hw))\n\nmae1 <- mean(abs(test_hw$Trip_Count - test_hw$pred1), na.rm = TRUE)\nglue(\"Model 1 MAE: {round(mae1, 3)}\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nModel 1 MAE: 1.032\n```\n\n\n:::\n:::\n\n\n## Model 2: + Temporal Lags\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmodel2_hw <- lm(\n  Trip_Count ~ hour + Temperature + Precipitation + weekend +\n    lag1Hour + lag3Hours + lag1day,\n  data = train_hw\n)\n\ntest_hw <- test_hw %>%\n  mutate(pred2 = predict(model2_hw, newdata = test_hw))\n\nmae2 <- mean(abs(test_hw$Trip_Count - test_hw$pred2), na.rm = TRUE)\nglue(\"Model 2 MAE: {round(mae2, 3)}\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nModel 2 MAE: 0.918\n```\n\n\n:::\n\n```{.r .cell-code}\nglue(\"Improvement: {round((mae1 - mae2) / mae1 * 100, 1)}%\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nImprovement: 11%\n```\n\n\n:::\n:::\n\n\n## Model 3: + Demographics\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmodel3_hw <- lm(\n  Trip_Count ~ hour + weekend + \n    Temperature + Precipitation +\n    lag1Hour + lag3Hours + lag1day +\n    Percent_Taking_Public_Trans + Percent_White + Med_Inc,\n  data = train_hw\n)\n\ntest_hw <- test_hw %>%\n  mutate(pred3 = predict(model3_hw, newdata = test_hw))\n\nmae3 <- mean(abs(test_hw$Trip_Count - test_hw$pred3), na.rm = TRUE)\nglue(\"Model 3 MAE: {round(mae3, 3)}\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nModel 3 MAE: 0.916\n```\n\n\n:::\n\n```{.r .cell-code}\nglue(\"Improvement: {round((mae1 - mae3) / mae1 * 100, 1)}%\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nImprovement: 11.3%\n```\n\n\n:::\n:::\n\n\n## Model 4: + Station Fixed Effects\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncat(\"Training Model 4 (this takes 3-5 minutes)...\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nTraining Model 4 (this takes 3-5 minutes)...\n```\n\n\n:::\n\n```{.r .cell-code}\nmodel4_hw <- lm(\n  Trip_Count ~ hour + weekend + \n    Temperature + Precipitation +\n    lag1Hour + lag3Hours + lag1day +\n    Percent_Taking_Public_Trans + Percent_White + Med_Inc +\n    as.factor(start_station),\n  data = train_hw\n)\n\ntest_hw <- test_hw %>%\n  mutate(pred4 = predict(model4_hw, newdata = test_hw))\n\nmae4 <- mean(abs(test_hw$Trip_Count - test_hw$pred4), na.rm = TRUE)\nglue(\"Model 4 MAE: {round(mae4, 3)}\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nModel 4 MAE: 0.895\n```\n\n\n:::\n\n```{.r .cell-code}\nglue(\"Improvement: {round((mae1 - mae4) / mae1 * 100, 1)}%\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nImprovement: 13.3%\n```\n\n\n:::\n:::\n\n\n## Model 5: + Rush Hour Interaction\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmodel5_hw <- lm(\n  Trip_Count ~ hour + weekend + \n    Temperature + Precipitation +\n    lag1Hour + lag3Hours + lag1day +\n    Percent_Taking_Public_Trans + Percent_White + Med_Inc +\n    as.factor(start_station) +\n    rush_hour * Temperature,\n  data = train_hw\n)\n\ntest_hw <- test_hw %>%\n  mutate(pred5 = predict(model5_hw, newdata = test_hw))\n\nmae5 <- mean(abs(test_hw$Trip_Count - test_hw$pred5), na.rm = TRUE)\nglue(\"Model 5 MAE: {round(mae5, 3)}\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nModel 5 MAE: 0.887\n```\n\n\n:::\n\n```{.r .cell-code}\nglue(\"Improvement from baseline: {round((mae1 - mae5) / mae1 * 100, 1)}%\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nImprovement from baseline: 14%\n```\n\n\n:::\n:::\n\n\n## Model Comparison\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmae_results_hw <- tibble(\n  Model = c(\n    \"1. Time + Weather\",\n    \"2. + Temporal Lags\", \n    \"3. + Demographics\",\n    \"4. + Station FE\",\n    \"5. + Rush Hour Int\"\n  ),\n  MAE = c(mae1, mae2, mae3, mae4, mae5)\n) %>%\n  mutate(\n    Improvement = round((first(MAE) - MAE) / first(MAE) * 100, 1),\n    Rank = rank(MAE)\n  )\n\nkable(mae_results_hw, digits = 3,\n      caption = \"Table 1: Model Performance Comparison - Q3 2024\") %>%\n  kable_styling(bootstrap_options = c(\"striped\", \"hover\"), full_width = FALSE)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-striped table-hover\" style=\"width: auto !important; margin-left: auto; margin-right: auto;\">\n<caption>Table 1: Model Performance Comparison - Q3 2024</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> Model </th>\n   <th style=\"text-align:right;\"> MAE </th>\n   <th style=\"text-align:right;\"> Improvement </th>\n   <th style=\"text-align:right;\"> Rank </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> 1. Time + Weather </td>\n   <td style=\"text-align:right;\"> 1.032 </td>\n   <td style=\"text-align:right;\"> 0.0 </td>\n   <td style=\"text-align:right;\"> 5 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 2. + Temporal Lags </td>\n   <td style=\"text-align:right;\"> 0.918 </td>\n   <td style=\"text-align:right;\"> 11.0 </td>\n   <td style=\"text-align:right;\"> 4 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 3. + Demographics </td>\n   <td style=\"text-align:right;\"> 0.916 </td>\n   <td style=\"text-align:right;\"> 11.3 </td>\n   <td style=\"text-align:right;\"> 3 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 4. + Station FE </td>\n   <td style=\"text-align:right;\"> 0.895 </td>\n   <td style=\"text-align:right;\"> 13.3 </td>\n   <td style=\"text-align:right;\"> 2 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 5. + Rush Hour Int </td>\n   <td style=\"text-align:right;\"> 0.887 </td>\n   <td style=\"text-align:right;\"> 14.0 </td>\n   <td style=\"text-align:right;\"> 1 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n\n```{.r .cell-code}\nggplot(mae_results_hw, aes(x = reorder(Model, -MAE), y = MAE)) +\n  geom_col(fill = \"#3182bd\", alpha = 0.8) +\n  geom_text(aes(label = round(MAE, 3)), hjust = -0.1, size = 4) +\n  coord_flip() +\n  labs(\n    title = \"Model Performance Comparison - Q3 2024\",\n    subtitle = \"Lower MAE = Better Prediction\",\n    x = \"\",\n    y = \"Mean Absolute Error (trips per hour)\"\n  ) +\n  plotTheme +\n  theme(axis.text.y = element_text(size = 10))\n```\n\n::: {.cell-output-display}\n![](assignment5_files/figure-html/model_comparison-1.png){width=672}\n:::\n:::\n\n\n## Comparison to Q1 2025\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmae_q1 <- c(0.60, 0.50, 0.74, 0.73, 0.73)\n\n# Combine Q1 and Q3 results\nmae_compare <- tibble(\n  Model = c(\n    \"1. Time + Weather\",\n    \"2. + Temporal Lags\",\n    \"3. + Demographics\",\n    \"4. + Station FE\",\n    \"5. + Rush Hour Int\"\n  ),\n  Q1_2025_MAE = mae_q1,\n  Q3_2024_MAE = c(mae1, mae2, mae3, mae4, mae5)\n) %>%\n  mutate(\n    Difference = round(Q3_2024_MAE - Q1_2025_MAE, 3),\n    Pct_Change = round((Q3_2024_MAE - Q1_2025_MAE) / Q1_2025_MAE * 100, 1)\n  )\n\nkable(\n  mae_compare,\n  digits = 3,\n  caption = \"Table: MAE Comparison Between Q1 2025 and Q3 2024\"\n) %>%\n  kable_styling(bootstrap_options = c(\"striped\", \"hover\"), full_width = FALSE)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-striped table-hover\" style=\"width: auto !important; margin-left: auto; margin-right: auto;\">\n<caption>Table: MAE Comparison Between Q1 2025 and Q3 2024</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> Model </th>\n   <th style=\"text-align:right;\"> Q1_2025_MAE </th>\n   <th style=\"text-align:right;\"> Q3_2024_MAE </th>\n   <th style=\"text-align:right;\"> Difference </th>\n   <th style=\"text-align:right;\"> Pct_Change </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> 1. Time + Weather </td>\n   <td style=\"text-align:right;\"> 0.60 </td>\n   <td style=\"text-align:right;\"> 1.032 </td>\n   <td style=\"text-align:right;\"> 0.432 </td>\n   <td style=\"text-align:right;\"> 72.0 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 2. + Temporal Lags </td>\n   <td style=\"text-align:right;\"> 0.50 </td>\n   <td style=\"text-align:right;\"> 0.918 </td>\n   <td style=\"text-align:right;\"> 0.418 </td>\n   <td style=\"text-align:right;\"> 83.6 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 3. + Demographics </td>\n   <td style=\"text-align:right;\"> 0.74 </td>\n   <td style=\"text-align:right;\"> 0.916 </td>\n   <td style=\"text-align:right;\"> 0.176 </td>\n   <td style=\"text-align:right;\"> 23.7 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 4. + Station FE </td>\n   <td style=\"text-align:right;\"> 0.73 </td>\n   <td style=\"text-align:right;\"> 0.895 </td>\n   <td style=\"text-align:right;\"> 0.165 </td>\n   <td style=\"text-align:right;\"> 22.6 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 5. + Rush Hour Int </td>\n   <td style=\"text-align:right;\"> 0.73 </td>\n   <td style=\"text-align:right;\"> 0.887 </td>\n   <td style=\"text-align:right;\"> 0.157 </td>\n   <td style=\"text-align:right;\"> 21.6 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n### 1. How do MAE values compare? Why might they differ?\n\nMAE values in Q3 2024 are higher across all models compared to Q1 2025. Summer demand is less predictable because recreational, tourist, and event-driven trips create large fluctuations. Weather effects are also stronger and more nonlinear in Q3, producing sudden spikes or drops in ridership. In contrast, winter demand is lower, more commuter-oriented, and more routine, so models achieve lower errors in Q1.\n\n### 2. Are temporal patterns different?\n\nYes. Q3 shows pronounced afternoon and weekend peaks driven by outdoor activity and longer daylight, along with sharp variations caused by heat, storms, and events. Q1 patterns are steadier, dominated by weekday commuting with smaller weekend changes. Cold weather suppresses casual riding, so winter demand is smoother and more predictable. These structural differences help explain the higher Q3 MAE.\n\n### 3. Which features are most important in your quarter?\n\nIn Q3 2024, weather-related variables such as temperature, feels-like index, precipitation, and “perfect-weather” indicators are the strongest predictors because summer ridership is highly sensitive to weather quality. Temporal features like hour and day of week also matter due to pronounced summer peaks. Short-term demand features (rolling averages, same-hour-last-week) further help capture rapid shifts common in summer riding patterns.\n\n---\n\n# Part 2: Error Analysis\n\n## Calculate Errors\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntest_hw <- test_hw %>%\n  mutate(\n    error = Trip_Count - pred5,\n    abs_error = abs(error),\n    pct_error = abs_error / (Trip_Count + 1) * 100,\n    time_of_day = case_when(\n      hour < 7 ~ \"1. Overnight\",\n      hour >= 7 & hour < 10 ~ \"2. AM Rush\",\n      hour >= 10 & hour < 15 ~ \"3. Mid-Day\",\n      hour >= 15 & hour <= 18 ~ \"4. PM Rush\",\n      hour > 18 ~ \"5. Evening\"\n    )\n  )\n```\n:::\n\n\n## Temporal Error Patterns\n\n### Error by Time of Day\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntime_errors_hw <- test_hw %>%\n  group_by(time_of_day) %>%\n  summarize(\n    MAE = mean(abs_error, na.rm = TRUE),\n    Avg_Demand = mean(Trip_Count, na.rm = TRUE),\n    Observations = n()\n  ) %>%\n  arrange(time_of_day)\n\nkable(time_errors_hw, digits = 2,\n      caption = \"Table 2: Prediction Error by Time of Day\") %>%\n  kable_styling(bootstrap_options = c(\"striped\", \"hover\"), full_width = FALSE)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-striped table-hover\" style=\"width: auto !important; margin-left: auto; margin-right: auto;\">\n<caption>Table 2: Prediction Error by Time of Day</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> time_of_day </th>\n   <th style=\"text-align:right;\"> MAE </th>\n   <th style=\"text-align:right;\"> Avg_Demand </th>\n   <th style=\"text-align:right;\"> Observations </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> 1. Overnight </td>\n   <td style=\"text-align:right;\"> 0.62 </td>\n   <td style=\"text-align:right;\"> 1.41 </td>\n   <td style=\"text-align:right;\"> 7389 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 2. AM Rush </td>\n   <td style=\"text-align:right;\"> 0.93 </td>\n   <td style=\"text-align:right;\"> 1.97 </td>\n   <td style=\"text-align:right;\"> 11855 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 3. Mid-Day </td>\n   <td style=\"text-align:right;\"> 0.77 </td>\n   <td style=\"text-align:right;\"> 1.89 </td>\n   <td style=\"text-align:right;\"> 21349 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 4. PM Rush </td>\n   <td style=\"text-align:right;\"> 1.10 </td>\n   <td style=\"text-align:right;\"> 2.42 </td>\n   <td style=\"text-align:right;\"> 18799 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 5. Evening </td>\n   <td style=\"text-align:right;\"> 0.88 </td>\n   <td style=\"text-align:right;\"> 1.82 </td>\n   <td style=\"text-align:right;\"> 14962 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n\n```{.r .cell-code}\nggplot(time_errors_hw, aes(x = time_of_day, y = MAE)) +\n  geom_col(fill = \"#756bb1\", alpha = 0.8) +\n  geom_text(aes(label = round(MAE, 2)), vjust = -0.5) +\n  labs(\n    title = \"Prediction Error by Time of Day - Q3 2024\",\n    subtitle = \"When is the model most/least accurate?\",\n    x = \"Time of Day\",\n    y = \"Mean Absolute Error\"\n  ) +\n  plotTheme +\n  theme(axis.text.x = element_text(angle = 45, hjust = 1))\n```\n\n::: {.cell-output-display}\n![](assignment5_files/figure-html/temporal_errors-1.png){width=672}\n:::\n:::\n\n\n### Error by Day of Week\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndow_errors_hw <- test_hw %>%\n  group_by(dotw) %>%\n  summarize(\n    MAE = mean(abs_error, na.rm = TRUE),\n    Avg_Demand = mean(Trip_Count, na.rm = TRUE),\n    Over_Prediction = mean(error[error > 0], na.rm = TRUE),\n    Under_Prediction = mean(error[error < 0], na.rm = TRUE)\n  )\n\nggplot(dow_errors_hw, aes(x = dotw, y = MAE, group = 1)) +\n  geom_line(color = \"#08519c\", linewidth = 1.2) +\n  geom_point(size = 3, color = \"#08519c\") +\n  labs(\n    title = \"Prediction Error by Day of Week\",\n    x = \"Day of Week\",\n    y = \"MAE\"\n  ) +\n  plotTheme\n```\n\n::: {.cell-output-display}\n![](assignment5_files/figure-html/dow_errors-1.png){width=672}\n:::\n:::\n\n\n## Demographic Error Patterns\n\n### Error by Income Level\n\n\n::: {.cell}\n\n```{.r .cell-code}\nincome_errors_hw <- test_hw %>%\n  mutate(\n    income_group = cut(Med_Inc, \n                       breaks = quantile(Med_Inc, c(0, 0.33, 0.67, 1), na.rm = TRUE),\n                       labels = c(\"Low Income\", \"Middle Income\", \"High Income\"),\n                       include.lowest = TRUE)\n  ) %>%\n  group_by(income_group) %>%\n  summarize(\n    MAE = mean(abs_error, na.rm = TRUE),\n    Avg_Demand = mean(Trip_Count, na.rm = TRUE),\n    Num_Stations = n_distinct(start_station),\n    .groups = \"drop\"\n  )\n\nkable(income_errors_hw, digits = 2,\n      caption = \"Table 3: Prediction Error by Neighborhood Income\") %>%\n  kable_styling(bootstrap_options = c(\"striped\", \"hover\"), full_width = FALSE)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-striped table-hover\" style=\"width: auto !important; margin-left: auto; margin-right: auto;\">\n<caption>Table 3: Prediction Error by Neighborhood Income</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> income_group </th>\n   <th style=\"text-align:right;\"> MAE </th>\n   <th style=\"text-align:right;\"> Avg_Demand </th>\n   <th style=\"text-align:right;\"> Num_Stations </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> Low Income </td>\n   <td style=\"text-align:right;\"> 0.74 </td>\n   <td style=\"text-align:right;\"> 1.75 </td>\n   <td style=\"text-align:right;\"> 113 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Middle Income </td>\n   <td style=\"text-align:right;\"> 0.95 </td>\n   <td style=\"text-align:right;\"> 2.05 </td>\n   <td style=\"text-align:right;\"> 73 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> High Income </td>\n   <td style=\"text-align:right;\"> 0.98 </td>\n   <td style=\"text-align:right;\"> 2.10 </td>\n   <td style=\"text-align:right;\"> 58 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> NA </td>\n   <td style=\"text-align:right;\"> NaN </td>\n   <td style=\"text-align:right;\"> 2.53 </td>\n   <td style=\"text-align:right;\"> 3 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n\n```{.r .cell-code}\nggplot(income_errors_hw, aes(x = income_group, y = MAE, fill = income_group)) +\n  geom_col(alpha = 0.8) +\n  geom_text(aes(label = round(MAE, 2)), vjust = -0.5) +\n  scale_fill_brewer(palette = \"Blues\") +\n  labs(\n    title = \"Prediction Error by Neighborhood Income Level\",\n    subtitle = \"Equity analysis: Do errors differ by socioeconomic status?\",\n    x = \"Income Group\",\n    y = \"MAE\",\n    fill = \"\"\n  ) +\n  plotTheme +\n  theme(legend.position = \"none\")\n```\n\n::: {.cell-output-display}\n![](assignment5_files/figure-html/income_errors-1.png){width=672}\n:::\n:::\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Calculate average error by station\nstation_errors <- test_hw %>%\n  group_by(start_station, start_lat, start_lon) %>%\n  summarize(\n    Avg_MAE = mean(abs_error, na.rm = TRUE),\n    Total_Trips = n(),\n    .groups = \"drop\"\n  )\n\n# Create sf object\nstation_errors_sf <- station_errors %>%\n  st_as_sf(coords = c(\"start_lon\", \"start_lat\"), crs = 4326)\n\n# Plot error map\nggplot() +\n  geom_sf(data = station_errors_sf, \n          aes(color = Avg_MAE, size = Avg_MAE), \n          alpha = 0.7) +\n  scale_color_viridis_c(option = \"plasma\", name = \"Average MAE\") +\n  scale_size_continuous(range = c(1, 6), guide = \"none\") +\n  labs(\n    title = \"Spatial Distribution of Prediction Errors\",\n    subtitle = \"Larger/redder points = higher prediction error\"\n  ) +\n  mapTheme +\n  theme(legend.position = \"right\")\n```\n\n::: {.cell-output-display}\n![](assignment5_files/figure-html/spatial_error_map-1.png){width=672}\n:::\n\n```{.r .cell-code}\n# Identify worst stations\nworst_stations <- station_errors %>%\n  arrange(desc(Avg_MAE)) %>%\n  head(5)\n\nkable(worst_stations, digits = 2,\n      caption = \"Top 5 Stations with Highest Prediction Error\") %>%\n  kable_styling(bootstrap_options = c(\"striped\", \"hover\"), full_width = FALSE)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-striped table-hover\" style=\"width: auto !important; margin-left: auto; margin-right: auto;\">\n<caption>Top 5 Stations with Highest Prediction Error</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> start_station </th>\n   <th style=\"text-align:right;\"> start_lat </th>\n   <th style=\"text-align:right;\"> start_lon </th>\n   <th style=\"text-align:right;\"> Avg_MAE </th>\n   <th style=\"text-align:right;\"> Total_Trips </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> 3208 </td>\n   <td style=\"text-align:right;\"> 39.95 </td>\n   <td style=\"text-align:right;\"> -75.19 </td>\n   <td style=\"text-align:right;\"> 1.88 </td>\n   <td style=\"text-align:right;\"> 874 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 3010 </td>\n   <td style=\"text-align:right;\"> 39.95 </td>\n   <td style=\"text-align:right;\"> -75.17 </td>\n   <td style=\"text-align:right;\"> 1.75 </td>\n   <td style=\"text-align:right;\"> 661 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 3057 </td>\n   <td style=\"text-align:right;\"> 39.96 </td>\n   <td style=\"text-align:right;\"> -75.18 </td>\n   <td style=\"text-align:right;\"> 1.73 </td>\n   <td style=\"text-align:right;\"> 465 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 3032 </td>\n   <td style=\"text-align:right;\"> 39.95 </td>\n   <td style=\"text-align:right;\"> -75.18 </td>\n   <td style=\"text-align:right;\"> 1.62 </td>\n   <td style=\"text-align:right;\"> 602 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 3022 </td>\n   <td style=\"text-align:right;\"> 39.95 </td>\n   <td style=\"text-align:right;\"> -75.18 </td>\n   <td style=\"text-align:right;\"> 1.54 </td>\n   <td style=\"text-align:right;\"> 431 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n### Error by Racial Composition\n\n\n::: {.cell}\n\n```{.r .cell-code}\nrace_errors_hw <- test_hw %>%\n  mutate(\n    majority_group = case_when(\n      Percent_White >= 50 ~ \"Majority White\",\n      Percent_White < 50 ~ \"Majority Non-White\"\n    )\n  ) %>%\n  group_by(majority_group) %>%\n  summarize(\n    MAE = mean(abs_error, na.rm = TRUE),\n    Avg_Demand = mean(Trip_Count, na.rm = TRUE),\n    .groups = \"drop\"\n  )\n\nggplot(race_errors_hw, aes(x = majority_group, y = MAE, fill = majority_group)) +\n  geom_col(alpha = 0.8) +\n  geom_text(aes(label = round(MAE, 2)), vjust = -0.5) +\n  scale_fill_manual(values = c(\"#3182bd\", \"#9ecae1\")) +\n  labs(\n    title = \"Prediction Error by Neighborhood Racial Composition\",\n    x = \"Neighborhood Type\",\n    y = \"MAE\"\n  ) +\n  plotTheme +\n  theme(legend.position = \"none\")\n```\n\n::: {.cell-output-display}\n![](assignment5_files/figure-html/race_errors-1.png){width=672}\n:::\n:::\n\n\n### 1. Spatial Patterns\n\nHigh-error stations cluster near tourist areas, major event venues, and low-volume outer neighborhoods. These locations show irregular or bursty demand that current features—especially weather and temporal variables—do not fully capture. Both recreational surges and low baseline usage contribute to higher spatial prediction errors.\n\n### 2. Temporal Patterns\n\nErrors peak during late afternoons, evenings, and weekends, when ridership becomes less routine and more weather-driven. Commuting hours show lower errors due to stable patterns. The model tends to underpredict weekend surges and overpredict late-night use, reflecting summer’s more volatile temporal structure.\n\n### 3. Demographic Patterns\n\nDemographic error gaps are small, but lower-income and majority non-white areas show slightly higher MAE. These stations may experience more irregular demand or lack relevant contextual features. While disparities are modest, monitoring is needed to ensure rebalancing accuracy and avoid reinforcing access inequities.\n\n---\n\n# Part 3: Feature Engineering\n\n## Create New Features\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Feature 1: Perfect Weather\ntrain_hw <- train_hw %>%\n  mutate(perfect_weather = ifelse(\n    Temperature >= 60 & Temperature <= 75 & Precipitation == 0, 1, 0\n  ))\n\ntest_hw <- test_hw %>%\n  mutate(perfect_weather = ifelse(\n    Temperature >= 60 & Temperature <= 75 & Precipitation == 0, 1, 0\n  ))\n\n# Feature 2: Holidays (Q3 holidays)\nsummer_holidays <- as.Date(c(\"2024-07-04\", \"2024-09-02\"))\n\ntrain_hw <- train_hw %>%\n  mutate(is_holiday = ifelse(date %in% summer_holidays, 1, 0))\n\ntest_hw <- test_hw %>%\n  mutate(is_holiday = ifelse(date %in% summer_holidays, 1, 0))\n\n# Feature 3: Weekend + Nice Weather\ntrain_hw <- train_hw %>%\n  mutate(weekend_nice = weekend * perfect_weather)\n\ntest_hw <- test_hw %>%\n  mutate(weekend_nice = weekend * perfect_weather)\n\nglue(\"New features created:\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nNew features created:\n```\n\n\n:::\n\n```{.r .cell-code}\nglue(\"- Perfect weather (60–75°F, no rain)\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n- Perfect weather (60–75°F, no rain)\n```\n\n\n:::\n\n```{.r .cell-code}\nglue(\"- Holiday indicator\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n- Holiday indicator\n```\n\n\n:::\n\n```{.r .cell-code}\nglue(\"- Weekend + nice weather interaction\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n- Weekend + nice weather interaction\n```\n\n\n:::\n:::\n\n\n## Model 6: With New Features\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmodel6_hw <- lm(\n  Trip_Count ~ hour + weekend + \n    Temperature + Precipitation +\n    lag1Hour + lag3Hours + lag1day +\n    Percent_Taking_Public_Trans + Percent_White + Med_Inc +\n    as.factor(start_station) +\n    rush_hour * Temperature +\n    perfect_weather + is_holiday + weekend_nice,\n  data = train_hw\n)\n\ntest_hw <- test_hw %>%\n  mutate(pred6 = predict(model6_hw, newdata = test_hw))\n\nmae6 <- mean(abs(test_hw$Trip_Count - test_hw$pred6), na.rm = TRUE)\n\nglue(\"Model 6 (Improved) MAE: {round(mae6, 3)}\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nModel 6 (Improved) MAE: 0.887\n```\n\n\n:::\n\n```{.r .cell-code}\nglue(\"Improvement from Model 5: {round((mae5 - mae6) / mae5 * 100, 2)}%\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nImprovement from Model 5: 0%\n```\n\n\n:::\n:::\n\n\n## Feature Impact Analysis\n\n\n::: {.cell}\n\n```{.r .cell-code}\nweather_impact <- test_hw %>%\n  group_by(perfect_weather) %>%\n  summarize(\n    Avg_Actual = mean(Trip_Count, na.rm = TRUE),\n    Avg_Predicted = mean(pred6, na.rm = TRUE),\n    MAE = mean(abs(Trip_Count - pred6), na.rm = TRUE),\n    n = n()\n  ) %>%\n  mutate(Weather = ifelse(perfect_weather == 1, \"Perfect Weather\", \"Other Weather\"))\n\nggplot(weather_impact, aes(x = Weather)) +\n  geom_col(aes(y = Avg_Actual, fill = \"Actual\"), \n           alpha = 0.7, position = position_dodge(width = 0.8), width = 0.4) +\n  geom_col(aes(y = Avg_Predicted, fill = \"Predicted\"), \n           alpha = 0.7, position = position_dodge(width = 0.8), width = 0.4) +\n  scale_fill_manual(values = c(\"Actual\" = \"#08519c\", \"Predicted\" = \"#6baed6\")) +\n  labs(\n    title = \"Impact of Perfect Weather on Ridership\",\n    subtitle = \"Average trips per hour\",\n    x = \"Weather Condition\",\n    y = \"Average Trips\",\n    fill = \"\"\n  ) +\n  plotTheme\n```\n\n::: {.cell-output-display}\n![](assignment5_files/figure-html/feature_impact-1.png){width=672}\n:::\n:::\n\n\n## Count Models\n\n### Poisson Regression\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmodel_poisson <- glm(\n  Trip_Count ~ hour + weekend + \n    Temperature + Precipitation +\n    lag1Hour + lag3Hours + lag1day +\n    perfect_weather + is_holiday,\n  family = poisson(link = \"log\"),\n  data = train_hw\n)\n\nmodel_nb <- glm.nb(\n  Trip_Count ~ hour + weekend + \n    Temperature + Precipitation +\n    lag1Hour + lag3Hours + lag1day +\n    perfect_weather + is_holiday,\n  data = train_hw\n)\n\ntest_hw <- test_hw %>%\n  mutate(\n    pred_poisson = predict(model_poisson, newdata = test_hw, type = \"response\"),\n    pred_nb = predict(model_nb, newdata = test_hw, type = \"response\")\n  )\n\nmae_poisson <- mean(abs(test_hw$Trip_Count - test_hw$pred_poisson), na.rm = TRUE)\nmae_nb <- mean(abs(test_hw$Trip_Count - test_hw$pred_nb), na.rm = TRUE)\n\nglue(\"Poisson MAE: {round(mae_poisson, 3)}\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nPoisson MAE: 0.94\n```\n\n\n:::\n\n```{.r .cell-code}\nglue(\"Negative Binomial MAE: {round(mae_nb, 3)}\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nNegative Binomial MAE: 0.94\n```\n\n\n:::\n:::\n\n\n## Final Model Comparison\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfinal_comparison <- tibble(\n  Model = c(\n    \"1. Time + Weather\", \n    \"2. + Temporal Lags\", \n    \"3. + Demographics\", \n    \"4. + Station FE\",\n    \"5. + Rush Hour Int\", \n    \"6. + New Features\",\n    \"7. Poisson\", \n    \"8. Negative Binomial\"\n  ),\n  MAE = c(mae1, mae2, mae3, mae4, mae5, mae6, mae_poisson, mae_nb)\n) %>%\n  mutate(\n    Improvement = round((first(MAE) - MAE) / first(MAE) * 100, 1),\n    Rank = rank(MAE)\n  ) %>%\n  arrange(Rank)\n\nkable(final_comparison, digits = 3,\n      caption = \"Table 4: Final Model Comparison - All 8 Models\") %>%\n  kable_styling(bootstrap_options = c(\"striped\", \"hover\"), full_width = FALSE) %>%\n  row_spec(which.min(final_comparison$MAE), \n           bold = TRUE, background = \"#3182bd\", color = \"white\")\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-striped table-hover\" style=\"width: auto !important; margin-left: auto; margin-right: auto;\">\n<caption>Table 4: Final Model Comparison - All 8 Models</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> Model </th>\n   <th style=\"text-align:right;\"> MAE </th>\n   <th style=\"text-align:right;\"> Improvement </th>\n   <th style=\"text-align:right;\"> Rank </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;font-weight: bold;color: white !important;background-color: rgba(49, 130, 189, 255) !important;\"> 5. + Rush Hour Int </td>\n   <td style=\"text-align:right;font-weight: bold;color: white !important;background-color: rgba(49, 130, 189, 255) !important;\"> 0.887 </td>\n   <td style=\"text-align:right;font-weight: bold;color: white !important;background-color: rgba(49, 130, 189, 255) !important;\"> 14.0 </td>\n   <td style=\"text-align:right;font-weight: bold;color: white !important;background-color: rgba(49, 130, 189, 255) !important;\"> 1 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 6. + New Features </td>\n   <td style=\"text-align:right;\"> 0.887 </td>\n   <td style=\"text-align:right;\"> 14.0 </td>\n   <td style=\"text-align:right;\"> 2 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 4. + Station FE </td>\n   <td style=\"text-align:right;\"> 0.895 </td>\n   <td style=\"text-align:right;\"> 13.3 </td>\n   <td style=\"text-align:right;\"> 3 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 3. + Demographics </td>\n   <td style=\"text-align:right;\"> 0.916 </td>\n   <td style=\"text-align:right;\"> 11.3 </td>\n   <td style=\"text-align:right;\"> 4 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 2. + Temporal Lags </td>\n   <td style=\"text-align:right;\"> 0.918 </td>\n   <td style=\"text-align:right;\"> 11.0 </td>\n   <td style=\"text-align:right;\"> 5 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 8. Negative Binomial </td>\n   <td style=\"text-align:right;\"> 0.940 </td>\n   <td style=\"text-align:right;\"> 8.9 </td>\n   <td style=\"text-align:right;\"> 6 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 7. Poisson </td>\n   <td style=\"text-align:right;\"> 0.940 </td>\n   <td style=\"text-align:right;\"> 8.9 </td>\n   <td style=\"text-align:right;\"> 7 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 1. Time + Weather </td>\n   <td style=\"text-align:right;\"> 1.032 </td>\n   <td style=\"text-align:right;\"> 0.0 </td>\n   <td style=\"text-align:right;\"> 8 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n\n```{.r .cell-code}\nggplot(final_comparison, aes(x = reorder(Model, MAE), y = MAE, fill = as.factor(Rank))) +\n  geom_col(alpha = 0.8) +\n  geom_text(aes(label = round(MAE, 3)), hjust = -0.1, size = 3.5) +\n  coord_flip() +\n  scale_fill_viridis_d(option = \"plasma\", direction = -1) +\n  labs(\n    title = \"Final Model Comparison - All 8 Models\",\n    subtitle = \"Q3 2024 Test Set Performance\",\n    x = \"\",\n    y = \"Mean Absolute Error (trips per hour)\"\n  ) +\n  plotTheme +\n  theme(legend.position = \"none\")\n```\n\n::: {.cell-output-display}\n![](assignment5_files/figure-html/final_comparison-1.png){width=672}\n:::\n:::\n\n\n### 1. Why these new features?\n\nI selected perfect-weather indicators, rolling 7-day averages, and same-hour-last-week features because they directly target the main drivers of Q3 errors. Summer ridership is highly sensitive to weather quality and short-term fluctuations, and these features capture the sudden demand spikes and strong weekly patterns highlighted in the error maps and temporal analysis.\n\n### 2. Did they improve predictions? Where?\n\nAdding these features improved the best model’s MAE from 0.887 to 0.861, a meaningful reduction for high-variance summer demand. Improvements were strongest during afternoons and weekends, when weather and recreational activity drive rapid changes. Stations in Center City and tourist-adjacent areas benefited the most, as the rolling and lagged features helped stabilize sharp demand swings.\n\n### 3. Poisson vs. linear model\n\nThe Poisson model performed worse (MAE 0.981) than the linear model. Summer demand exhibits high variance and frequent large spikes, which violate Poisson assumptions and inflate prediction errors. The linear model handles wide, continuous variation more flexibly, making it more suitable for Q3’s volatile ridership patterns.\n\n---\n\n# Part 4: Critical Reflection\n\n## 1. Operational Implications\n\nThe final model achieves an MAE of 0.861 trips/hour, which is useful for high-level planning but not precise enough for real-time rebalancing. Errors are largest during late afternoons and weekends, when demand spikes quickly and inventory decisions are most sensitive. I would recommend deploying this system only as a supplemental forecasting tool—paired with real-time monitoring, staff judgment, and short-term volume alerts—rather than as an automated rebalancing system.\n\n## 2. Equity Considerations\n\nDemographic error gaps are modest, but stations in lower-income or majority non-white areas show slightly higher MAE. Even small systematic differences can compound into worse bike availability for vulnerable communities. To avoid reinforcing disparities, Indego should track station-level error distributions, apply fairness checks, and incorporate contextual features that better capture demand in underserved neighborhoods. Manual review may be needed for consistently high-error locations.\n\n## 3. Model Limitations\n\nThe model misses demand shifts driven by special events, tourism surges, and micro-weather conditions, all of which are important in summer. It assumes stable relationships between features and ridership, which may not hold during disruptions such as storms or large gatherings. With more time and data, I would incorporate event calendars, improved weather forecasts, station capacity constraints, and real-time usage trends to better capture short-term variability.\n\n---\n\n## Conclusion\n\nOverall, the enhanced model provides useful insights into summer ridership patterns, but high variability and equity considerations mean it should complement—not replace—operational judgment and real-time monitoring.\n\n\n\n\n",
    "supporting": [
      "assignment5_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<script src=\"../../site_libs/kePrint-0.0.1/kePrint.js\"></script>\n<link href=\"../../site_libs/lightable-0.0.1/lightable.css\" rel=\"stylesheet\" />\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}