---
title: "EDA: Philadelphia Eviction Data Analysis"
subtitle: "MUSA 5080 Final Project"
author: "Fang Zhe"
date: today
format:
  html:
    toc: true
    toc-depth: 3
    code-fold: true
    theme: cosmo
    self-contained: true
execute:
  warning: false
  message: false
---

# Setup

```{r setup}
library(tidyverse)
library(sf)
library(tigris)
library(viridis)
library(corrplot)
library(knitr)
library(kableExtra)
library(lubridate)
library(readxl)
library(scales)
library(patchwork)

options(scipen = 999)
options(tigris_use_cache = TRUE)

# Plot themes
plotTheme <- theme_minimal() +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    plot.subtitle = element_text(size = 10),
    axis.title = element_text(size = 10),
    axis.text = element_text(size = 9),
    legend.position = "right"
  )

mapTheme <- theme_void() +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    legend.position = "right"
  )
```

---

# Part 1: Data Loading

```{r load_data}
# Load all datasets
changes_claims <- read.csv("eviction_data/changes_claims.csv")
demographics <- read.csv("eviction_data/demographics.csv")
eviction_hotspots <- read.csv("eviction_data/eviction_hotspots.csv")
filings_baseline <- read.csv("eviction_data/filings_relative_baseline.csv")
tract_filings <- read.csv("eviction_data/tract_level_filings.csv")
tract_filing_rate <- read.csv("eviction_data/tract_level_filing_rate.csv")
eviction_trends <- read.csv("eviction_data/trends_eviction.csv")

# Load Excel files
unemployment <- read_xlsx("eviction_data/unemployment_rate_montly.xlsx")
cpi <- read_xlsx("eviction_data/consumer_price_index_monthly.xlsx")
financial_health <- read_xlsx("eviction_data/financial-health-of-residents-data.xlsx")

cat("All data loaded successfully!\n")
```

---

# Part 2: Eviction Trends Over Time

## 2.1 Monthly Eviction Filings

```{r trends_time}
# Parse date from eviction_trends
eviction_trends_clean <- eviction_trends %>%
  mutate(
    month_num = as.integer(substr(month, 1, 2)),
    year = as.integer(substr(month, 4, 7)),
    date = as.Date(paste0(year, "-", month_num, "-01"))
  )

# Plot monthly filings over time
ggplot(eviction_trends_clean, aes(x = date, y = month_filings)) +
  geom_line(color = "#2c7fb8", linewidth = 1) +
  geom_point(color = "#2c7fb8", size = 2) +
  geom_hline(yintercept = mean(eviction_trends_clean$month_filings, na.rm = TRUE), 
             linetype = "dashed", color = "red", alpha = 0.7) +
  labs(
    title = "Monthly Eviction Filings in Philadelphia",
    subtitle = "Red dashed line = average",
    x = "Date",
    y = "Number of Filings"
  ) +
  scale_y_continuous(labels = comma) +
  plotTheme
```

## 2.2 Eviction Filings vs Baseline

```{r baseline_comparison}
ggplot(eviction_trends_clean, aes(x = date, y = percentage_diff)) +
  geom_line(color = "#41b6c4", linewidth = 1) +
  geom_point(color = "#41b6c4", size = 2) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "black") +
  labs(
    title = "Eviction Filings Relative to Pre-Pandemic Baseline",
    subtitle = "Values above 0 = higher than baseline",
    x = "Date",
    y = "Percentage Difference from Baseline"
  ) +
  plotTheme
```

## 2.3 Distribution of Monthly Filings

```{r filings_distribution}
ggplot(eviction_trends_clean, aes(x = month_filings)) +
  geom_histogram(bins = 15, fill = "#2c7fb8", color = "white", alpha = 0.8) +
  geom_vline(xintercept = mean(eviction_trends_clean$month_filings, na.rm = TRUE),
             linetype = "dashed", color = "red", linewidth = 1) +
  labs(
    title = "Distribution of Monthly Eviction Filings",
    subtitle = paste("Mean =", round(mean(eviction_trends_clean$month_filings, na.rm = TRUE), 0)),
    x = "Monthly Filings",
    y = "Count"
  ) +
  plotTheme
```

---

# Part 3: Economic Indicators

## 3.1 Unemployment Rate Trend

```{r unemployment_trend}
# Clean unemployment data (header is in row 10)
unemp_clean <- unemployment
names(unemp_clean) <- as.character(unlist(unemp_clean[10, ]))
unemp_clean <- unemp_clean[-(1:10), ]

# Convert to long format
month_names <- c("Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec")

unemp_long <- unemp_clean %>%
  mutate(Year = as.integer(as.numeric(Year))) %>%
  select(Year, all_of(month_names)) %>%
  pivot_longer(cols = all_of(month_names),
               names_to = "month_name",
               values_to = "unemployment_rate") %>%
  mutate(
    unemployment_rate = as.numeric(unemployment_rate),
    month_num = match(month_name, month_names),
    date = as.Date(paste0(Year, "-", month_num, "-01"))
  ) %>%
  filter(!is.na(unemployment_rate))

# Plot
ggplot(unemp_long, aes(x = date, y = unemployment_rate)) +
  geom_line(color = "#d95f02", linewidth = 1) +
  geom_point(color = "#d95f02", size = 1.5) +
  labs(
    title = "Philadelphia Unemployment Rate Over Time",
    x = "Date",
    y = "Unemployment Rate (%)"
  ) +
  plotTheme
```

## 3.2 Consumer Price Index (CPI) Trend

```{r cpi_trend}
# Clean CPI data (header is in row 11)
cpi_clean <- cpi
names(cpi_clean) <- as.character(unlist(cpi_clean[11, ]))
cpi_clean <- cpi_clean[-(1:11), ]

cpi_long <- cpi_clean %>%
  mutate(Year = as.integer(as.numeric(Year))) %>%
  select(Year, all_of(month_names)) %>%
  pivot_longer(cols = all_of(month_names),
               names_to = "month_name",
               values_to = "cpi_value") %>%
  mutate(
    cpi_value = as.numeric(cpi_value),
    month_num = match(month_name, month_names),
    date = as.Date(paste0(Year, "-", month_num, "-01"))
  ) %>%
  filter(!is.na(cpi_value))

ggplot(cpi_long, aes(x = date, y = cpi_value)) +
  geom_line(color = "#7570b3", linewidth = 1) +
  labs(
    title = "Consumer Price Index (CPI) Over Time",
    subtitle = "Philadelphia Metro Area",
    x = "Date",
    y = "CPI"
  ) +
  plotTheme
```

## 3.3 Combined Economic Trends

```{r combined_economic}
# Merge eviction trends with economic indicators
eviction_econ <- eviction_trends_clean %>%
  left_join(unemp_long %>% select(date, unemployment_rate), by = "date") %>%
  left_join(cpi_long %>% select(date, cpi_value), by = "date")

# Create dual-axis plot
p1 <- ggplot(eviction_econ, aes(x = date)) +
  geom_line(aes(y = month_filings, color = "Eviction Filings"), linewidth = 1) +
  labs(title = "Eviction Filings Over Time", y = "Filings", x = "") +
  scale_color_manual(values = c("Eviction Filings" = "#2c7fb8")) +
  plotTheme + theme(legend.position = "none")

p2 <- ggplot(eviction_econ, aes(x = date)) +
  geom_line(aes(y = unemployment_rate, color = "Unemployment"), linewidth = 1) +
  labs(title = "Unemployment Rate", y = "Rate (%)", x = "") +
  scale_color_manual(values = c("Unemployment" = "#d95f02")) +
  plotTheme + theme(legend.position = "none")

p1 / p2 + plot_annotation(title = "Economic Disruption and Evictions")
```

---

# Part 4: Spatial Distribution

## 4.1 Load Census Tract Geometry

```{r load_tracts}
# Get Philadelphia census tracts
philly_tracts <- tracts(state = "PA", county = "Philadelphia", year = 2022) %>%
  st_transform(crs = 4326)

cat("Philadelphia has", nrow(philly_tracts), "census tracts\n")
```

## 4.2 Eviction Rate by Census Tract

```{r spatial_eviction}
# Prepare tract filings data
tract_filings_clean <- tract_filing_rate %>%
  mutate(GEOID = as.character(id)) %>%
  group_by(GEOID) %>%
  summarize(
    avg_month_rate = mean(month_rate, na.rm = TRUE),
    total_filings = n()
  )

# Join to geometry
evictions_geo <- philly_tracts %>%
  left_join(tract_filings_clean, by = "GEOID")

# Map
ggplot(evictions_geo) +
  geom_sf(aes(fill = avg_month_rate), color = NA) +
  scale_fill_viridis_c(option = "magma", na.value = "grey90",
                       name = "Avg Monthly\nFiling Rate") +
  labs(
    title = "Average Eviction Filing Rate by Census Tract",
    subtitle = "Philadelphia, PA"
  ) +
  mapTheme
```

## 4.3 Eviction Hotspots Map

```{r hotspots_map}
# Check if we have location data in hotspots
if ("lat" %in% names(eviction_hotspots) & "lon" %in% names(eviction_hotspots)) {
  hotspots_sf <- eviction_hotspots %>%
    filter(!is.na(lat), !is.na(lon)) %>%
    st_as_sf(coords = c("lon", "lat"), crs = 4326)
  
  ggplot() +
    geom_sf(data = philly_tracts, fill = "grey95", color = "grey70") +
    geom_sf(data = hotspots_sf, aes(size = filings), 
            color = "red", alpha = 0.6) +
    labs(
      title = "Eviction Hotspots in Philadelphia",
      subtitle = "Top buildings with most eviction filings",
      size = "Filings"
    ) +
    mapTheme
} else {
  cat("Hotspot location data not available in expected format\n")
  glimpse(eviction_hotspots)
}
```

---

# Part 5: Demographic Patterns

## 5.1 Evictions by Neighborhood Racial Composition

```{r demographic_patterns}
# Check demographics data structure
if ("pct_white" %in% names(tract_filing_rate)) {
  tract_demo <- tract_filing_rate %>%
    mutate(
      majority_type = case_when(
        pct_white > 0.5 ~ "Majority White",
        pct_black > 0.5 ~ "Majority Black",
        pct_hispanic > 0.5 ~ "Majority Hispanic",
        TRUE ~ "No Majority"
      )
    )
  
  demo_summary <- tract_demo %>%
    group_by(majority_type) %>%
    summarize(
      avg_rate = mean(month_rate, na.rm = TRUE),
      n_obs = n()
    )
  
  ggplot(demo_summary, aes(x = reorder(majority_type, -avg_rate), y = avg_rate, fill = majority_type)) +
    geom_col() +
    geom_text(aes(label = round(avg_rate, 3)), vjust = -0.5) +
    scale_fill_brewer(palette = "Set2") +
    labs(
      title = "Average Eviction Rate by Neighborhood Type",
      x = "Neighborhood Majority",
      y = "Average Monthly Filing Rate"
    ) +
    plotTheme +
    theme(legend.position = "none")
} else {
  cat("Demographic columns not found. Checking available columns:\n")
  names(tract_filing_rate)
}
```

## 5.2 Demographics Distribution

```{r demographics_overview}
# If we have the demographics file
if (nrow(demographics) > 0) {
  glimpse(demographics)
  
  # Summary statistics
  kable(summary(demographics), caption = "Demographics Summary") %>%
    kable_styling(bootstrap_options = c("striped", "hover"))
}
```

---

# Part 6: Correlation Analysis

## 6.1 Merge All Variables

```{r merge_for_correlation}
# Create analysis dataset
analysis_df <- eviction_econ %>%
  filter(!is.na(unemployment_rate), !is.na(cpi_value)) %>%
  select(date, month_filings, percentage_diff, unemployment_rate, cpi_value)

cat("Analysis dataset has", nrow(analysis_df), "observations\n")
glimpse(analysis_df)
```

## 6.2 Correlation Matrix

```{r correlation_matrix}
# Select numeric variables for correlation
cor_vars <- analysis_df %>%
  select(month_filings, percentage_diff, unemployment_rate, cpi_value) %>%
  na.omit()

if (nrow(cor_vars) > 5) {
  cor_matrix <- cor(cor_vars)
  
  corrplot(cor_matrix, 
           method = "color",
           type = "upper",
           addCoef.col = "black",
           tl.col = "black",
           tl.srt = 45,
           title = "Correlation Matrix: Evictions and Economic Indicators",
           mar = c(0, 0, 2, 0))
} else {
  cat("Not enough observations for correlation analysis\n")
}
```

## 6.3 Scatter Plots

```{r scatter_plots}
# Eviction vs Unemployment
p1 <- ggplot(analysis_df, aes(x = unemployment_rate, y = month_filings)) +
  geom_point(color = "#2c7fb8", alpha = 0.7, size = 3) +
  geom_smooth(method = "lm", se = TRUE, color = "red") +
  labs(
    title = "Evictions vs Unemployment",
    x = "Unemployment Rate (%)",
    y = "Monthly Filings"
  ) +
  plotTheme

# Eviction vs CPI
p2 <- ggplot(analysis_df, aes(x = cpi_value, y = month_filings)) +
  geom_point(color = "#7570b3", alpha = 0.7, size = 3) +
  geom_smooth(method = "lm", se = TRUE, color = "red") +
  labs(
    title = "Evictions vs CPI",
    x = "Consumer Price Index",
    y = "Monthly Filings"
  ) +
  plotTheme

p1 + p2
```

---

# Part 7: Summary Statistics

## 7.1 Key Statistics Table

```{r summary_stats}
# Eviction trends summary
eviction_summary <- eviction_trends_clean %>%
  summarize(
    `Mean Monthly Filings` = mean(month_filings, na.rm = TRUE),
    `SD Monthly Filings` = sd(month_filings, na.rm = TRUE),
    `Min Filings` = min(month_filings, na.rm = TRUE),
    `Max Filings` = max(month_filings, na.rm = TRUE),
    `Mean % Diff from Baseline` = mean(percentage_diff, na.rm = TRUE),
    `Months Observed` = n()
  ) %>%
  pivot_longer(everything(), names_to = "Statistic", values_to = "Value")

kable(eviction_summary, digits = 2, caption = "Eviction Trends Summary") %>%
  kable_styling(bootstrap_options = c("striped", "hover"))
```

## 7.2 Economic Indicators Summary

```{r econ_summary}
econ_summary <- analysis_df %>%
  summarize(
    `Mean Unemployment Rate` = mean(unemployment_rate, na.rm = TRUE),
    `SD Unemployment` = sd(unemployment_rate, na.rm = TRUE),
    `Mean CPI` = mean(cpi_value, na.rm = TRUE),
    `SD CPI` = sd(cpi_value, na.rm = TRUE)
  ) %>%
  pivot_longer(everything(), names_to = "Statistic", values_to = "Value")

kable(econ_summary, digits = 2, caption = "Economic Indicators Summary") %>%
  kable_styling(bootstrap_options = c("striped", "hover"))
```

---

# Part 8: Key Findings for Presentation

## Summary of EDA Findings

Based on the exploratory analysis:

1. **Temporal Patterns:**
   - Eviction filings show [describe pattern you see]
   - Clear relationship with economic disruptions during [time period]

2. **Economic Relationships:**
   - Unemployment rate shows [positive/negative/weak] correlation with evictions
   - CPI (inflation) shows [describe relationship]

3. **Spatial Patterns:**
   - Evictions are concentrated in [describe areas]
   - Hotspots are primarily located in [describe]

4. **Demographic Disparities:**
   - [Describe any racial/ethnic patterns]
   - Majority [X] neighborhoods have [higher/lower] eviction rates

## Charts for Slides

The following visualizations are recommended for the presentation:

1. Monthly eviction trends over time
2. Eviction vs Unemployment scatter plot
3. Spatial map of eviction rates by tract
4. Demographic comparison bar chart

---

*EDA completed: `r Sys.Date()`*
