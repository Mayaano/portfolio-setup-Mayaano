---
title: "EDA: Philadelphia Eviction Data Analysis"
subtitle: "MUSA 5080 Final Project - Comprehensive Exploratory Analysis"
author: "Fang Zhe"
date: today
format:
  html:
    toc: true
    toc-depth: 3
    code-fold: true
    theme: cosmo
    self-contained: true
execute:
  warning: false
  message: false
---

# Setup

```{r setup}
library(tidyverse)
library(sf)
library(tigris)
library(viridis)
library(corrplot)
library(knitr)
library(kableExtra)
library(lubridate)
library(readxl)
library(scales)
library(patchwork)
library(spdep)  # For spatial autocorrelation

options(scipen = 999)
options(tigris_use_cache = TRUE)

# Custom plot themes
plotTheme <- theme_minimal() +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    plot.subtitle = element_text(size = 10, color = "grey40"),
    axis.title = element_text(size = 10),
    axis.text = element_text(size = 9),
    legend.position = "right",
    panel.grid.minor = element_blank()
  )

mapTheme <- theme_void() +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    plot.subtitle = element_text(size = 10, color = "grey40"),
    legend.position = "right"
  )

# Color palettes
eviction_color <- "#e31a1c"
unemp_color <- "#1f78b4"
cpi_color <- "#33a02c"
```

---

# Part 1: Data Loading

```{r load_data}
# Load all datasets
changes_claims <- read.csv("eviction_data/changes_claims.csv")
demographics <- read.csv("eviction_data/demographics.csv")
eviction_hotspots <- read.csv("eviction_data/eviction_hotspots.csv")
filings_baseline <- read.csv("eviction_data/filings_relative_baseline.csv")
tract_filings <- read.csv("eviction_data/tract_level_filings.csv")
tract_filing_rate <- read.csv("eviction_data/tract_level_filing_rate.csv")
eviction_trends <- read.csv("eviction_data/trends_eviction.csv")

# Load Excel files
unemployment <- read_xlsx("eviction_data/unemployment_rate_montly.xlsx")
cpi <- read_xlsx("eviction_data/consumer_price_index_monthly.xlsx")
financial_health <- read_xlsx("eviction_data/financial-health-of-residents-data.xlsx")

# Data summary
cat("=== Data Loading Summary ===\n")
cat("Eviction trends:", nrow(eviction_trends), "months\n")
cat("Tract-level filings:", nrow(tract_filings), "observations\n")
cat("Tract filing rates:", nrow(tract_filing_rate), "observations\n")
cat("Eviction hotspots:", nrow(eviction_hotspots), "locations\n")
```

---

# Part 2: Eviction Trends Over Time

## 2.1 Monthly Eviction Filings

```{r trends_time}
# Parse date from eviction_trends
eviction_trends_clean <- eviction_trends %>%
  mutate(
    month_num = as.integer(substr(month, 1, 2)),
    year = as.integer(substr(month, 4, 7)),
    date = as.Date(paste0(year, "-", month_num, "-01"))
  ) %>%
  arrange(date)

# Plot monthly filings over time
ggplot(eviction_trends_clean, aes(x = date, y = month_filings)) +
  geom_line(color = eviction_color, linewidth = 1) +
  geom_point(color = eviction_color, size = 2) +
  geom_hline(yintercept = mean(eviction_trends_clean$month_filings, na.rm = TRUE), 
             linetype = "dashed", color = "grey50", alpha = 0.7) +
  annotate("text", x = min(eviction_trends_clean$date), 
           y = mean(eviction_trends_clean$month_filings, na.rm = TRUE) + 100,
           label = paste("Average:", round(mean(eviction_trends_clean$month_filings, na.rm = TRUE), 0)),
           hjust = 0, color = "grey50", size = 3.5) +
  labs(
    title = "Monthly Eviction Filings in Philadelphia",
    subtitle = "Tracking eviction activity over time",
    x = "Date",
    y = "Number of Filings"
  ) +
  scale_y_continuous(labels = comma) +
  scale_x_date(date_breaks = "6 months", date_labels = "%b %Y") +
  plotTheme +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

## 2.2 Eviction Filings vs Baseline

```{r baseline_comparison}
# Identify periods above/below baseline
eviction_trends_clean <- eviction_trends_clean %>%
  mutate(above_baseline = percentage_diff > 0)

ggplot(eviction_trends_clean, aes(x = date, y = percentage_diff)) +
  geom_area(aes(fill = above_baseline), alpha = 0.3) +
  geom_line(color = "grey30", linewidth = 0.8) +
  geom_point(aes(color = above_baseline), size = 2) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "black", linewidth = 1) +
  scale_fill_manual(values = c("TRUE" = eviction_color, "FALSE" = unemp_color), guide = "none") +
  scale_color_manual(values = c("TRUE" = eviction_color, "FALSE" = unemp_color), guide = "none") +
  labs(
    title = "Eviction Filings Relative to Pre-Pandemic Baseline",
    subtitle = "Red = above baseline, Blue = below baseline",
    x = "Date",
    y = "Percentage Difference from Baseline (%)"
  ) +
  scale_x_date(date_breaks = "6 months", date_labels = "%b %Y") +
  plotTheme +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

## 2.3 Year-over-Year Comparison

```{r yoy_comparison}
# Year-over-year comparison
eviction_yoy <- eviction_trends_clean %>%
  mutate(month_name = month(date, label = TRUE)) %>%
  group_by(year, month_name) %>%
  summarize(filings = sum(month_filings, na.rm = TRUE), .groups = "drop")

ggplot(eviction_yoy, aes(x = month_name, y = filings, color = factor(year), group = year)) +
  geom_line(linewidth = 1) +
  geom_point(size = 2) +
  scale_color_brewer(palette = "Set1", name = "Year") +
  labs(
    title = "Eviction Filings by Month: Year-over-Year Comparison",
    subtitle = "Seasonal patterns and annual changes",
    x = "Month",
    y = "Filings"
  ) +
  scale_y_continuous(labels = comma) +
  plotTheme
```

---

# Part 3: Economic Indicators Analysis

## 3.1 Unemployment Rate Trend

```{r unemployment_trend}
# Clean unemployment data
unemp_clean <- unemployment
names(unemp_clean) <- as.character(unlist(unemp_clean[10, ]))
unemp_clean <- unemp_clean[-(1:10), ]

month_names <- c("Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec")

unemp_long <- unemp_clean %>%
  mutate(Year = as.integer(as.numeric(Year))) %>%
  select(Year, all_of(month_names)) %>%
  pivot_longer(cols = all_of(month_names),
               names_to = "month_name",
               values_to = "unemployment_rate") %>%
  mutate(
    unemployment_rate = as.numeric(unemployment_rate),
    month_num = match(month_name, month_names),
    date = as.Date(paste0(Year, "-", month_num, "-01"))
  ) %>%
  filter(!is.na(unemployment_rate)) %>%
  arrange(date)

ggplot(unemp_long, aes(x = date, y = unemployment_rate)) +
  geom_line(color = unemp_color, linewidth = 1) +
  geom_point(color = unemp_color, size = 1.5) +
  geom_vline(xintercept = as.Date("2020-03-01"), linetype = "dashed", color = "red", alpha = 0.7) +
  annotate("text", x = as.Date("2020-03-01"), y = max(unemp_long$unemployment_rate, na.rm = TRUE),
           label = "COVID-19", hjust = -0.1, color = "red", size = 3) +
  labs(
    title = "Philadelphia Unemployment Rate Over Time",
    subtitle = "Economic disruption indicator",
    x = "Date",
    y = "Unemployment Rate (%)"
  ) +
  scale_x_date(date_breaks = "1 year", date_labels = "%Y") +
  plotTheme
```

## 3.2 Consumer Price Index (CPI) Trend

```{r cpi_trend}
# Clean CPI data
cpi_clean <- cpi
names(cpi_clean) <- as.character(unlist(cpi_clean[11, ]))
cpi_clean <- cpi_clean[-(1:11), ]

cpi_long <- cpi_clean %>%
  mutate(Year = as.integer(as.numeric(Year))) %>%
  select(Year, all_of(month_names)) %>%
  pivot_longer(cols = all_of(month_names),
               names_to = "month_name",
               values_to = "cpi_value") %>%
  mutate(
    cpi_value = as.numeric(cpi_value),
    month_num = match(month_name, month_names),
    date = as.Date(paste0(Year, "-", month_num, "-01"))
  ) %>%
  filter(!is.na(cpi_value)) %>%
  arrange(date)

# Calculate YoY inflation
cpi_long <- cpi_long %>%
  mutate(cpi_yoy_change = (cpi_value / lag(cpi_value, 12) - 1) * 100)

ggplot(cpi_long %>% filter(!is.na(cpi_yoy_change)), aes(x = date, y = cpi_yoy_change)) +
  geom_line(color = cpi_color, linewidth = 1) +
  geom_hline(yintercept = 2, linetype = "dashed", color = "grey50") +
  annotate("text", x = min(cpi_long$date, na.rm = TRUE) + 365, y = 2.3,
           label = "2% Target", color = "grey50", size = 3) +
  labs(
    title = "Year-over-Year Inflation Rate (CPI)",
    subtitle = "Philadelphia Metro Area",
    x = "Date",
    y = "Inflation Rate (%)"
  ) +
  scale_x_date(date_breaks = "1 year", date_labels = "%Y") +
  plotTheme
```

## 3.3 ⭐ Key Chart: Economic Disruption vs Evictions (Dual Y-Axis)

```{r dual_axis_key_chart, fig.width=10, fig.height=6}
# Merge eviction trends with economic indicators
eviction_econ <- eviction_trends_clean %>%
  left_join(unemp_long %>% select(date, unemployment_rate), by = "date") %>%
  left_join(cpi_long %>% select(date, cpi_value), by = "date") %>%
  filter(!is.na(unemployment_rate))

# Calculate scaling factor for dual axis
scale_factor <- max(eviction_econ$month_filings, na.rm = TRUE) / max(eviction_econ$unemployment_rate, na.rm = TRUE)

# Create dual-axis plot - THIS IS THE KEY STORY CHART
ggplot(eviction_econ, aes(x = date)) +
  # Eviction filings (primary axis)
  geom_line(aes(y = month_filings, color = "Eviction Filings"), linewidth = 1.2) +
  geom_point(aes(y = month_filings, color = "Eviction Filings"), size = 2) +
  # Unemployment rate (secondary axis)
  geom_line(aes(y = unemployment_rate * scale_factor, color = "Unemployment Rate"), 
            linewidth = 1.2, linetype = "dashed") +
  geom_point(aes(y = unemployment_rate * scale_factor, color = "Unemployment Rate"), size = 2) +
  # Dual Y-axis
  scale_y_continuous(
    name = "Monthly Eviction Filings",
    labels = comma,
    sec.axis = sec_axis(~./scale_factor, name = "Unemployment Rate (%)")
  ) +
  scale_color_manual(
    name = "Indicator",
    values = c("Eviction Filings" = eviction_color, "Unemployment Rate" = unemp_color)
  ) +
  labs(
    title = "Economic Disruption and Eviction Filings",
    subtitle = "Unemployment as a 'shock' indicator - Key relationship for predictive model",
    x = "Date"
  ) +
  scale_x_date(date_breaks = "6 months", date_labels = "%b %Y") +
  plotTheme +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "bottom",
    axis.title.y.right = element_text(color = unemp_color),
    axis.title.y.left = element_text(color = eviction_color)
  )
```

## 3.4 Lag Effect Analysis

```{r lag_analysis}
# Create lagged unemployment variables
eviction_econ_lag <- eviction_econ %>%
  arrange(date) %>%
  mutate(
    unemp_lag1 = lag(unemployment_rate, 1),
    unemp_lag2 = lag(unemployment_rate, 2),
    unemp_lag3 = lag(unemployment_rate, 3),
    unemp_change = unemployment_rate - lag(unemployment_rate, 1)
  ) %>%
  filter(!is.na(unemp_lag3))

# Correlation at different lags
lag_cors <- data.frame(
  Lag = c("Same Month", "1 Month Lag", "2 Month Lag", "3 Month Lag"),
  Correlation = c(
    cor(eviction_econ_lag$month_filings, eviction_econ_lag$unemployment_rate, use = "complete.obs"),
    cor(eviction_econ_lag$month_filings, eviction_econ_lag$unemp_lag1, use = "complete.obs"),
    cor(eviction_econ_lag$month_filings, eviction_econ_lag$unemp_lag2, use = "complete.obs"),
    cor(eviction_econ_lag$month_filings, eviction_econ_lag$unemp_lag3, use = "complete.obs")
  )
)

ggplot(lag_cors, aes(x = Lag, y = Correlation, fill = Correlation)) +
  geom_col() +
  geom_text(aes(label = round(Correlation, 3)), vjust = -0.5) +
  scale_fill_gradient2(low = unemp_color, mid = "white", high = eviction_color, midpoint = 0) +
  labs(
    title = "Correlation Between Unemployment and Evictions at Different Lags",
    subtitle = "Testing whether economic shocks precede eviction changes",
    x = "Lag Period",
    y = "Pearson Correlation"
  ) +
  ylim(min(lag_cors$Correlation) - 0.1, max(lag_cors$Correlation) + 0.15) +
  plotTheme +
  theme(legend.position = "none")
```

---

# Part 4: Spatial Distribution Analysis

## 4.1 Load Census Tract Geometry

```{r load_tracts}
# Get Philadelphia census tracts
philly_tracts <- tracts(state = "PA", county = "Philadelphia", year = 2022) %>%
  st_transform(crs = 4326)

cat("Philadelphia has", nrow(philly_tracts), "census tracts\n")
```

## 4.2 Eviction Rate by Census Tract

```{r spatial_eviction}
# Prepare tract filings data
tract_filings_clean <- tract_filing_rate %>%
  mutate(GEOID = as.character(id)) %>%
  group_by(GEOID) %>%
  summarize(
    avg_month_rate = mean(month_rate, na.rm = TRUE),
    total_filings = sum(month_filings, na.rm = TRUE),
    n_months = n()
  )

# Join to geometry
evictions_geo <- philly_tracts %>%
  left_join(tract_filings_clean, by = "GEOID")

# Map
ggplot(evictions_geo) +
  geom_sf(aes(fill = avg_month_rate), color = "white", linewidth = 0.1) +
  scale_fill_viridis_c(option = "magma", na.value = "grey90",
                       name = "Avg Monthly\nFiling Rate") +
  labs(
    title = "Average Eviction Filing Rate by Census Tract",
    subtitle = "Philadelphia, PA - Spatial distribution of eviction vulnerability"
  ) +
  mapTheme
```

## 4.3 ⭐ Spatial Autocorrelation Analysis (Moran's I)

```{r spatial_autocorrelation, fig.width=10, fig.height=5}
# Prepare data for spatial analysis
evictions_geo_clean <- evictions_geo %>%
  filter(!is.na(avg_month_rate)) %>%
  st_transform(crs = 32618)  # UTM zone 18N for distance calculations

# Create spatial weights matrix
nb <- poly2nb(evictions_geo_clean, queen = TRUE)
lw <- nb2listw(nb, style = "W", zero.policy = TRUE)

# Global Moran's I test
moran_test <- moran.test(evictions_geo_clean$avg_month_rate, lw, zero.policy = TRUE)

cat("=== Global Moran's I Test ===\n")
cat("Moran's I:", round(moran_test$estimate[1], 4), "\n")
cat("Expected:", round(moran_test$estimate[2], 4), "\n")
cat("P-value:", format(moran_test$p.value, scientific = TRUE), "\n")
cat("\nInterpretation:", ifelse(moran_test$p.value < 0.05, 
    "Significant spatial clustering detected", 
    "No significant spatial clustering"), "\n")

# Local Moran's I (LISA)
local_moran <- localmoran(evictions_geo_clean$avg_month_rate, lw, zero.policy = TRUE)

evictions_geo_clean$local_i <- local_moran[, 1]
evictions_geo_clean$local_p <- local_moran[, 5]

# Classify LISA clusters
evictions_geo_clean <- evictions_geo_clean %>%
  mutate(
    mean_rate = mean(avg_month_rate, na.rm = TRUE),
    lag_rate = lag.listw(lw, avg_month_rate, zero.policy = TRUE),
    lisa_cluster = case_when(
      local_p > 0.05 ~ "Not Significant",
      avg_month_rate > mean_rate & lag_rate > mean_rate ~ "High-High (Hot Spot)",
      avg_month_rate < mean_rate & lag_rate < mean_rate ~ "Low-Low (Cold Spot)",
      avg_month_rate > mean_rate & lag_rate < mean_rate ~ "High-Low (Outlier)",
      avg_month_rate < mean_rate & lag_rate > mean_rate ~ "Low-High (Outlier)"
    )
  )

# LISA Cluster Map
ggplot(evictions_geo_clean %>% st_transform(4326)) +
  geom_sf(aes(fill = lisa_cluster), color = "white", linewidth = 0.1) +
  scale_fill_manual(
    values = c(
      "High-High (Hot Spot)" = "#d7191c",
      "Low-Low (Cold Spot)" = "#2c7bb6",
      "High-Low (Outlier)" = "#fdae61",
      "Low-High (Outlier)" = "#abd9e9",
      "Not Significant" = "grey90"
    ),
    name = "LISA Cluster"
  ) +
  labs(
    title = "Local Spatial Autocorrelation (LISA) of Eviction Rates",
    subtitle = paste("Global Moran's I =", round(moran_test$estimate[1], 3), 
                    "| Evictions are spatially clustered"),
    caption = "Hot spots (red) indicate clusters of high eviction rates"
  ) +
  mapTheme
```

## 4.4 Eviction Hot Spots

```{r hotspots_analysis}
# Identify top hot spot tracts
hotspot_tracts <- evictions_geo_clean %>%
  filter(lisa_cluster == "High-High (Hot Spot)") %>%
  st_drop_geometry() %>%
  arrange(desc(avg_month_rate)) %>%
  select(GEOID, avg_month_rate, total_filings, n_months)

cat("Number of Hot Spot tracts:", nrow(hotspot_tracts), "\n")
cat("Average eviction rate in hot spots:", round(mean(hotspot_tracts$avg_month_rate), 3), "\n")

if(nrow(hotspot_tracts) > 0) {
  kable(head(hotspot_tracts, 10), digits = 3, 
        caption = "Top 10 Eviction Hot Spot Census Tracts") %>%
    kable_styling(bootstrap_options = c("striped", "hover"))
}
```

---

# Part 5: Demographic & Equity Analysis

## 5.1 Evictions by Neighborhood Racial Composition

```{r demographic_patterns}
# Analyze by racial composition
tract_demo <- tract_filing_rate %>%
  mutate(
    # Note: Using pct_black (not pct_af_am) based on actual column names
    # Data uses proportions (0-1), not percentages (0-100)
    majority_type = case_when(
      pct_white > 0.5 ~ "Majority White",
      pct_black > 0.5 ~ "Majority Black",
      pct_hispanic > 0.5 ~ "Majority Hispanic",
      TRUE ~ "No Majority"
    )
  )

demo_summary <- tract_demo %>%
  group_by(majority_type) %>%
  summarize(
    avg_rate = mean(month_rate, na.rm = TRUE),
    median_rate = median(month_rate, na.rm = TRUE),
    n_obs = n(),
    n_tracts = n_distinct(id)
  ) %>%
  arrange(desc(avg_rate))

ggplot(demo_summary, aes(x = reorder(majority_type, -avg_rate), y = avg_rate, fill = majority_type)) +
  geom_col() +
  geom_errorbar(aes(ymin = avg_rate * 0.9, ymax = avg_rate * 1.1), width = 0.2) +
  geom_text(aes(label = paste0(round(avg_rate, 3), "\n(n=", n_tracts, ")")), vjust = -0.3, size = 3.5) +
  scale_fill_brewer(palette = "Set2") +
  labs(
    title = "Average Eviction Rate by Neighborhood Racial Composition",
    subtitle = "Equity Analysis: Disparities in eviction burden",
    x = "Neighborhood Type",
    y = "Average Monthly Filing Rate",
    caption = "n = number of unique census tracts"
  ) +
  plotTheme +
  theme(legend.position = "none") +
  ylim(0, max(demo_summary$avg_rate) * 1.3)
```

## 5.2 Distribution of Eviction Rates by Demographics

```{r demographic_distribution, fig.width=10, fig.height=5}
# Boxplot comparison
ggplot(tract_demo, aes(x = majority_type, y = month_rate, fill = majority_type)) +
  geom_boxplot(outlier.alpha = 0.3) +
  scale_fill_brewer(palette = "Set2") +
  labs(
    title = "Distribution of Monthly Eviction Rates by Neighborhood Type",
    subtitle = "Boxplots show median, quartiles, and outliers",
    x = "Neighborhood Type",
    y = "Monthly Filing Rate"
  ) +
  plotTheme +
  theme(legend.position = "none") +
  coord_cartesian(ylim = c(0, quantile(tract_demo$month_rate, 0.95, na.rm = TRUE)))
```

## 5.3 Racial Composition vs Eviction Rate (Scatter)

```{r race_scatter}
# Average by tract
tract_avg <- tract_filing_rate %>%
  group_by(id) %>%
  summarize(
    avg_rate = mean(month_rate, na.rm = TRUE),
    pct_black = first(pct_black),
    pct_white = first(pct_white),
    pct_hispanic = first(pct_hispanic)
  )

p1 <- ggplot(tract_avg, aes(x = pct_black * 100, y = avg_rate)) +
  geom_point(alpha = 0.5, color = "#1b9e77") +
  geom_smooth(method = "lm", se = TRUE, color = eviction_color) +
  labs(
    title = "% Black Population",
    x = "% Black",
    y = "Avg Eviction Rate"
  ) +
  plotTheme

p2 <- ggplot(tract_avg, aes(x = pct_white * 100, y = avg_rate)) +
  geom_point(alpha = 0.5, color = "#d95f02") +
  geom_smooth(method = "lm", se = TRUE, color = eviction_color) +
  labs(
    title = "% White Population",
    x = "% White",
    y = "Avg Eviction Rate"
  ) +
  plotTheme

p3 <- ggplot(tract_avg, aes(x = pct_hispanic * 100, y = avg_rate)) +
  geom_point(alpha = 0.5, color = "#7570b3") +
  geom_smooth(method = "lm", se = TRUE, color = eviction_color) +
  labs(
    title = "% Hispanic Population",
    x = "% Hispanic",
    y = "Avg Eviction Rate"
  ) +
  plotTheme

p1 + p2 + p3 + 
  plot_annotation(
    title = "Eviction Rates by Racial Composition",
    subtitle = "Correlation between neighborhood demographics and eviction vulnerability"
  )
```

## 5.4 Equity Summary Table

```{r equity_table}
# Detailed equity summary
equity_summary <- tract_demo %>%
  group_by(majority_type) %>%
  summarize(
    `Mean Eviction Rate` = mean(month_rate, na.rm = TRUE),
    `Median Eviction Rate` = median(month_rate, na.rm = TRUE),
    `Std Dev` = sd(month_rate, na.rm = TRUE),
    `Max Rate` = max(month_rate, na.rm = TRUE),
    `N Observations` = n(),
    `N Tracts` = n_distinct(id)
  ) %>%
  arrange(desc(`Mean Eviction Rate`))

# Calculate disparity ratio
baseline_rate <- equity_summary %>% 
  filter(majority_type == "Majority White") %>% 
  pull(`Mean Eviction Rate`)

equity_summary <- equity_summary %>%
  mutate(`Disparity Ratio` = `Mean Eviction Rate` / baseline_rate)

kable(equity_summary, digits = 3, 
      caption = "Eviction Rate Disparities by Neighborhood Type") %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  row_spec(which.max(equity_summary$`Mean Eviction Rate`), bold = TRUE, background = "#ffcccc")
```

---

# Part 6: Time-Space Interaction Analysis

## 6.1 Temporal Changes in Spatial Patterns

```{r time_space_interaction}
# Analyze how spatial patterns change over time
tract_time <- tract_filing_rate %>%
  mutate(
    GEOID = as.character(id),
    date = as.Date(month_date)
  )

# Create time periods
tract_time <- tract_time %>%
  mutate(
    period = case_when(
      date < as.Date("2020-03-01") ~ "Pre-COVID",
      date >= as.Date("2020-03-01") & date < as.Date("2021-01-01") ~ "COVID-2020",
      date >= as.Date("2021-01-01") & date < as.Date("2022-01-01") ~ "COVID-2021",
      date >= as.Date("2022-01-01") ~ "Post-COVID"
    )
  )

# Aggregate by period and tract
period_rates <- tract_time %>%
  group_by(GEOID, period) %>%
  summarize(
    avg_rate = mean(month_rate, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  pivot_wider(names_from = period, values_from = avg_rate)

# Join to geometry for mapping
period_geo <- philly_tracts %>%
  left_join(period_rates, by = "GEOID")

# Check available periods
available_periods <- names(period_rates)[-1]
cat("Available time periods:", paste(available_periods, collapse = ", "), "\n")
```

## 6.2 Eviction Rate Changes by Period

```{r period_comparison_maps, fig.width=12, fig.height=8}
# Create maps for each available period
map_list <- list()

for(period_name in available_periods) {
  if(period_name %in% names(period_geo)) {
    p <- ggplot(period_geo) +
      geom_sf(aes(fill = .data[[period_name]]), color = NA) +
      scale_fill_viridis_c(option = "magma", na.value = "grey90", limits = c(0, 0.015)) +
      labs(title = period_name, fill = "Rate") +
      mapTheme +
      theme(legend.position = "bottom", legend.key.width = unit(1.5, "cm"))
    map_list[[period_name]] <- p
  }
}

if(length(map_list) > 0) {
  wrap_plots(map_list, ncol = 2) +
    plot_annotation(
      title = "Evolution of Eviction Spatial Patterns Over Time",
      subtitle = "How eviction geography changed through COVID-19 pandemic"
    )
}
```

---

# Part 7: Correlation Analysis

## 7.1 Comprehensive Correlation Matrix

```{r correlation_analysis}
# Create analysis dataset
analysis_df <- eviction_econ %>%
  filter(!is.na(unemployment_rate), !is.na(cpi_value)) %>%
  select(date, month_filings, percentage_diff, unemployment_rate, cpi_value)

# Add lagged variables
analysis_df <- analysis_df %>%
  arrange(date) %>%
  mutate(
    filings_change = month_filings - lag(month_filings),
    unemp_change = unemployment_rate - lag(unemployment_rate),
    unemp_lag1 = lag(unemployment_rate, 1),
    unemp_lag2 = lag(unemployment_rate, 2)
  ) %>%
  filter(!is.na(unemp_lag2))

# Correlation matrix
cor_vars <- analysis_df %>%
  select(month_filings, percentage_diff, unemployment_rate, unemp_lag1, unemp_lag2, cpi_value) %>%
  na.omit()

if (nrow(cor_vars) > 5) {
  cor_matrix <- cor(cor_vars)
  
  corrplot(cor_matrix, 
           method = "color",
           type = "upper",
           addCoef.col = "black",
           tl.col = "black",
           tl.srt = 45,
           col = colorRampPalette(c(unemp_color, "white", eviction_color))(100),
           title = "Correlation Matrix: Evictions and Economic Indicators",
           mar = c(0, 0, 2, 0))
}
```

## 7.2 Key Scatter Plots

```{r scatter_plots, fig.width=10, fig.height=5}
# Eviction vs Unemployment
p1 <- ggplot(analysis_df, aes(x = unemployment_rate, y = month_filings)) +
  geom_point(color = unemp_color, alpha = 0.7, size = 3) +
  geom_smooth(method = "lm", se = TRUE, color = eviction_color) +
  labs(
    title = "Evictions vs Unemployment",
    subtitle = paste("r =", round(cor(analysis_df$month_filings, analysis_df$unemployment_rate, use = "complete.obs"), 3)),
    x = "Unemployment Rate (%)",
    y = "Monthly Filings"
  ) +
  plotTheme

# Eviction vs Lagged Unemployment
p2 <- ggplot(analysis_df, aes(x = unemp_lag1, y = month_filings)) +
  geom_point(color = cpi_color, alpha = 0.7, size = 3) +
  geom_smooth(method = "lm", se = TRUE, color = eviction_color) +
  labs(
    title = "Evictions vs Lagged Unemployment (1 month)",
    subtitle = paste("r =", round(cor(analysis_df$month_filings, analysis_df$unemp_lag1, use = "complete.obs"), 3)),
    x = "Unemployment Rate (1 month lag)",
    y = "Monthly Filings"
  ) +
  plotTheme

p1 + p2
```

---

# Part 8: Summary Statistics

## 8.1 Eviction Trends Summary

```{r summary_stats}
eviction_summary <- eviction_trends_clean %>%
  summarize(
    `Mean Monthly Filings` = mean(month_filings, na.rm = TRUE),
    `SD Monthly Filings` = sd(month_filings, na.rm = TRUE),
    `Min Filings` = min(month_filings, na.rm = TRUE),
    `Max Filings` = max(month_filings, na.rm = TRUE),
    `Mean % Diff from Baseline` = mean(percentage_diff, na.rm = TRUE),
    `Months Above Baseline` = sum(percentage_diff > 0, na.rm = TRUE),
    `Total Months` = n()
  ) %>%
  pivot_longer(everything(), names_to = "Statistic", values_to = "Value")

kable(eviction_summary, digits = 2, caption = "Eviction Trends Summary") %>%
  kable_styling(bootstrap_options = c("striped", "hover"))
```

## 8.2 Economic Indicators Summary

```{r econ_summary}
econ_summary <- analysis_df %>%
  summarize(
    `Mean Unemployment Rate` = mean(unemployment_rate, na.rm = TRUE),
    `Max Unemployment Rate` = max(unemployment_rate, na.rm = TRUE),
    `Min Unemployment Rate` = min(unemployment_rate, na.rm = TRUE),
    `Mean CPI` = mean(cpi_value, na.rm = TRUE),
    `Correlation: Eviction-Unemployment` = cor(month_filings, unemployment_rate, use = "complete.obs"),
    `Correlation: Eviction-Lagged Unemp` = cor(month_filings, unemp_lag1, use = "complete.obs")
  ) %>%
  pivot_longer(everything(), names_to = "Statistic", values_to = "Value")

kable(econ_summary, digits = 3, caption = "Economic Indicators Summary") %>%
  kable_styling(bootstrap_options = c("striped", "hover"))
```

---

# Part 9: Key Findings & Recommendations

## 9.1 Summary of EDA Findings

Based on the comprehensive exploratory analysis, here are the key findings:

### Temporal Patterns

```{r findings_temporal}
# Calculate key temporal stats
avg_filings <- mean(eviction_trends_clean$month_filings, na.rm = TRUE)
max_filings <- max(eviction_trends_clean$month_filings, na.rm = TRUE)
max_date <- eviction_trends_clean$date[which.max(eviction_trends_clean$month_filings)]
```

1. **Average monthly eviction filings:** `r format(round(avg_filings, 0), big.mark = ",")` cases
2. **Peak filings:** `r format(round(max_filings, 0), big.mark = ",")` cases in `r format(max_date, "%B %Y")`
3. **Clear seasonal patterns** with higher filings in certain months

### Economic Relationships

```{r findings_economic}
# Calculate correlations
cor_unemp <- cor(analysis_df$month_filings, analysis_df$unemployment_rate, use = "complete.obs")
cor_lag <- cor(analysis_df$month_filings, analysis_df$unemp_lag1, use = "complete.obs")
```

1. **Unemployment-Eviction correlation:** r = `r round(cor_unemp, 3)` (`r ifelse(cor_unemp > 0, "positive", "negative")` relationship)
2. **Lagged effect:** 1-month lagged unemployment shows r = `r round(cor_lag, 3)`
3. **Interpretation:** Unemployment serves as a "disruption" indicator affecting eviction rates

### Spatial Patterns

```{r findings_spatial}
# Get Moran's I result
moran_i <- round(moran_test$estimate[1], 3)
n_hotspots <- nrow(hotspot_tracts)
```

1. **Significant spatial clustering** detected (Moran's I = `r moran_i`, p < 0.001)
2. **`r n_hotspots` census tracts** identified as statistically significant hot spots
3. **Evictions are geographically concentrated**, not randomly distributed

### Equity Implications

```{r findings_equity}
# Get disparity info
max_disparity_group <- equity_summary$majority_type[which.max(equity_summary$`Mean Eviction Rate`)]
max_disparity_ratio <- round(max(equity_summary$`Disparity Ratio`, na.rm = TRUE), 2)
```

1. **Highest eviction rates** observed in `r max_disparity_group` neighborhoods
2. **Disparity ratio:** `r max_disparity_ratio`x higher than Majority White neighborhoods
3. **Significant equity concerns** require policy attention

## 9.2 Charts for Presentation Slides

The following visualizations are **recommended for the presentation**:

| Chart | Section | Purpose |
|-------|---------|---------|
| Dual Y-axis (Unemployment vs Evictions) | 3.3 | **Key story chart** - shows relationship |
| LISA Cluster Map | 4.3 | Shows spatial clustering (hot spots) |
| Demographic Bar Chart | 5.1 | Shows equity disparities |
| Correlation Scatter | 7.2 | Supports model validity |
| Period Comparison Maps | 6.2 | Shows temporal-spatial changes |

## 9.3 Implications for Model

Based on this EDA, the predictive model should:

1. **Include unemployment as key predictor** - strong correlation demonstrated
2. **Consider lagged effects** - 1-2 month lag may improve predictions
3. **Account for spatial clustering** - spatial features or fixed effects needed
4. **Address equity** - model errors should be monitored across demographic groups

---

*EDA completed: `r Sys.Date()`*

*Author: Fang Zhe | MUSA 5080 Final Project*
