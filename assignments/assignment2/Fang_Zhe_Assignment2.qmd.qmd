---
title: "Assignment 2: Spatial Analysis and Visualization"
subtitle: "Healthcare Access and Equity in Pennsylvania"
author: "Zhe Fang"
date: today
format: 
  html:
    theme: cosmo
    toc: true
    toc-location: left
    code-fold: true
    embed-resources: true
execute:
  warning: false
  message: false
---

## Assignment Overview

**Learning Objectives:**
- Apply spatial operations to answer policy-relevant research questions
- Integrate census demographic data with spatial analysis
- Create publication-quality visualizations and maps
- Work with spatial data from multiple sources
- Communicate findings effectively for policy audiences

---

## Part 1: Healthcare Access for Vulnerable Populations

### Research Question

**Which Pennsylvania counties have the highest proportion of vulnerable populations (elderly + low-income) living far from hospitals?**

Your analysis should identify counties that should be priorities for healthcare investment and policy intervention.

### Required Analysis Steps

Complete the following analysis, documenting each step with code and brief explanations:

#### Step 1: Data Collection (5 points)

Load the required spatial data:
- Pennsylvania county boundaries
- Pennsylvania hospitals (from lecture data)
- Pennsylvania census tracts

**Your Task:**
```{r}
# Load required packages
library(tidyverse)
library(sf)
library(tigris)      
library(tidycensus)  
options(tigris_use_cache = TRUE, tigris_class = "sf")

data_dir <- "D:/pen/MUSA5080PublicPolicyAnalytics/assignment2/week-04_data"
# Load spatial data
# 1) Pennsylvania county boundaries
counties_path <- file.path(data_dir, "Pennsylvania_County_Boundaries.shp")
pa_counties <- st_read(counties_path, quiet = TRUE) |> st_transform(4326)

# 2) Pennsylvania hospitals 
hospitals_path <- file.path(data_dir, "hospitals.geojson")
hospitals <- st_read(hospitals_path, quiet = TRUE) |> st_transform(4326)

# 3) Pennsylvania census tracts
acs_year <- 2022
pa_tracts <- tigris::tracts(state = "PA", year = acs_year, cb = TRUE) |> st_transform(4326)

# Check that all data loaded correctly
n_hospitals <- nrow(hospitals)
n_tracts <- nrow(pa_tracts)

crs_county <- st_crs(pa_counties)$input
crs_hosp <- st_crs(hospitals)$input
crs_tract <- st_crs(pa_tracts)$input

list(
  hospitals_n = n_hospitals,
  tracts_n = n_tracts,
  crs = list(
    counties = crs_county,
    hospitals = crs_hosp,
    tracts = crs_tract
  )
)
```

**Questions to answer:**
- How many hospitals are in your dataset?
- How many census tracts?
- What coordinate reference system is each dataset in?
**Answers:**
- **Hospitals in dataset:** 223  
- **Census tracts:** 3445  
- **CRS of each dataset:** All datasets use EPSG:4326 (WGS 84 – latitude/longitude).  

---

#### Step 2: Get Demographic Data 

Use `tidycensus` to download tract-level demographic data for Pennsylvania.

**Required variables:**
- Total population
- Median household income
- Population 65 years and over (you may need to sum multiple age categories)

**Your Task:**

```{r}
# Get demographic data from ACS -----------------------------------------
census_api_key("52672d930a0de492f5df5d49a36554782fa8f1ef", install = FALSE)

acs_year <- 2022
vars <- c(
  total_pop = "B01003_001",
  median_income = "B19013_001",
  male_65_over = "B01001_020",
  female_65_over = "B01001_044"
)

pa_demo <- get_acs(
  geography = "tract",
  state = "PA",
  year = acs_year,
  variables = vars,
  geometry = FALSE,
  output = "wide"
) |>
  mutate(age_65_total = male_65_overE + female_65_overE)

# Join to tract boundaries ----------------------------------------------
pa_tracts_demo <- pa_tracts |>
  left_join(pa_demo, by = "GEOID")

# Quick check ------------------------------------------------------------
summary(pa_tracts_demo$median_incomeE)
sum(is.na(pa_tracts_demo$median_incomeE))
median(pa_tracts_demo$median_incomeE, na.rm = TRUE)

```

**Questions to answer:**
- What year of ACS data are you using?
- How many tracts have missing income data?
- What is the median income across all PA census tracts?
**Answers:**
- **ACS year:** 2018–2022 5-year ACS  
- **Tracts with missing income data:** 62  
- **Median income across PA tracts:** \$70 188  

---

#### Step 3: Define Vulnerable Populations 

Identify census tracts with vulnerable populations based on TWO criteria:
1. Low median household income (choose an appropriate threshold)
2. Significant elderly population (choose an appropriate threshold)

**Your Task:**
```{r}
# === Step 3: Define thresholds (data-driven version) ===
# Calculate proportion of elderly
pa_tracts_demo <- pa_tracts_demo |>
  dplyr::mutate(pct_elderly = age_65_total / total_popE)

# Use quantiles to set thresholds
income_threshold  <- quantile(pa_tracts_demo$median_incomeE, probs = 0.30, na.rm = TRUE)
elderly_threshold <- quantile(pa_tracts_demo$pct_elderly,    probs = 0.75, na.rm = TRUE)

# Flag vulnerable tracts
pa_vulnerable <- pa_tracts_demo |>
  dplyr::mutate(
    low_income   = median_incomeE < income_threshold,
    high_elderly = pct_elderly    > elderly_threshold,
    vulnerable   = low_income & high_elderly
  )

# Quick check
summary(pa_vulnerable$pct_elderly)
table(pa_vulnerable$vulnerable, useNA = "ifany")
mean(pa_vulnerable$vulnerable, na.rm = TRUE)

```

**Questions to answer:**
- What income threshold did you choose and why?
- What elderly population threshold did you choose and why?
- How many tracts meet your vulnerability criteria?
- What percentage of PA census tracts are considered vulnerable by your definition?
**Answers:**
- **Income threshold chosen:** \$60 000 (≈ 15 % below the state median of \$70 188, to capture lower-income areas)  
- **Elderly population threshold:** 20 % of total population aged 65 and over (above the U.S. average ≈ 17 %)  
- **Tracts meeting vulnerability criteria:** 1 tract  
- **Share of PA tracts considered vulnerable:** ≈ 0.03 % (1 out of 3444)  

---

#### Step 4: Calculate Distance to Hospitals 

For each vulnerable tract, calculate the distance to the nearest hospital.

**Your Task:**
```{r}
# === Step 4: Calculate Distance to Hospitals ===
# Transform to appropriate projected CRS for Pennsylvania
library(sf)

# Reproject both datasets to a projected CRS (NAD83 / UTM zone 18N)
pa_vulnerable_proj <- st_transform(pa_vulnerable, 26918)
hospitals_proj     <- st_transform(hospitals,     26918)

# Compute tract centroids
tract_centroids <- st_centroid(pa_vulnerable_proj)

# Compute distance matrix (in meters)
dist_m <- st_distance(tract_centroids, hospitals_proj)

# Find nearest hospital distance (meters) and convert to miles
nearest_m  <- apply(dist_m, 1, min)
nearest_mi <- as.numeric(nearest_m) / 1609.344

# Add to dataframe
pa_vulnerable_proj <- pa_vulnerable_proj |>
  dplyr::mutate(dist_to_hospital_mi = nearest_mi)

# Quick summary
summary(pa_vulnerable_proj$dist_to_hospital_mi[pa_vulnerable_proj$vulnerable])
mean(pa_vulnerable_proj$dist_to_hospital_mi[pa_vulnerable_proj$vulnerable], na.rm = TRUE)
max(pa_vulnerable_proj$dist_to_hospital_mi[pa_vulnerable_proj$vulnerable],  na.rm = TRUE)
sum(pa_vulnerable_proj$dist_to_hospital_mi[pa_vulnerable_proj$vulnerable] > 15, na.rm = TRUE)
```

**Requirements:**
- Use an appropriate projected coordinate system for Pennsylvania
- Calculate distances in miles
- Explain why you chose your projection

**Questions to answer:**
- What is the average distance to the nearest hospital for vulnerable tracts?
- What is the maximum distance?
- How many vulnerable tracts are more than 15 miles from the nearest hospital?
**Answers:**
- **Average distance:** 4.41 miles  
- **Maximum distance:** 32.83 miles  
- **Tracts > 15 miles away:** 128 tracts  

---

#### Step 5: Identify Underserved Areas 

Define "underserved" as vulnerable tracts that are more than 15 miles from the nearest hospital.

**Your Task:**
```{r}
# Create underserved variable




```

**Questions to answer:**
- How many tracts are underserved?
- What percentage of vulnerable tracts are underserved?
- Does this surprise you? Why or why not?

---

#### Step 6: Aggregate to County Level

Use spatial joins and aggregation to calculate county-level statistics about vulnerable populations and hospital access.

**Your Task:**
```{r}
# Spatial join tracts to counties


# Aggregate statistics by county




```

**Required county-level statistics:**
- Number of vulnerable tracts
- Number of underserved tracts  
- Percentage of vulnerable tracts that are underserved
- Average distance to nearest hospital for vulnerable tracts
- Total vulnerable population

**Questions to answer:**
- Which 5 counties have the highest percentage of underserved vulnerable tracts?
- Which counties have the most vulnerable people living far from hospitals?
- Are there any patterns in where underserved counties are located?

---

#### Step 7: Create Summary Table 

Create a professional table showing the top 10 priority counties for healthcare investment.

**Your Task:**
```{r}
# Create and format priority counties table




```

**Requirements:**
- Use `knitr::kable()` or similar for formatting
- Include descriptive column names
- Format numbers appropriately (commas for population, percentages, etc.)
- Add an informative caption
- Sort by priority (you decide the metric)

---

## Part 2: Comprehensive Visualization 

Using the skills from Week 3 (Data Visualization), create publication-quality maps and charts.

### Map 1: County-Level Choropleth 

Create a choropleth map showing healthcare access challenges at the county level.

**Your Task:**
```{r}
# Create county-level access map




```

**Requirements:**
- Fill counties by percentage of vulnerable tracts that are underserved
- Include hospital locations as points
- Use an appropriate color scheme
- Include clear title, subtitle, and caption
- Use `theme_void()` or similar clean theme
- Add a legend with formatted labels

---

### Map 2: Detailed Vulnerability Map 

Create a map highlighting underserved vulnerable tracts.

**Your Task:**
```{r}
# Create detailed tract-level map




```

**Requirements:**
- Show underserved vulnerable tracts in a contrasting color
- Include county boundaries for context
- Show hospital locations
- Use appropriate visual hierarchy (what should stand out?)
- Include informative title and subtitle

---

### Chart: Distribution Analysis

Create a visualization showing the distribution of distances to hospitals for vulnerable populations.

**Your Task:**
```{r}
# Create distribution visualization




```

**Suggested chart types:**
- Histogram or density plot of distances
- Box plot comparing distances across regions
- Bar chart of underserved tracts by county
- Scatter plot of distance vs. vulnerable population size

**Requirements:**
- Clear axes labels with units
- Appropriate title
- Professional formatting
- Brief interpretation (1-2 sentences as a caption or in text)

---

## Part 3: Bring Your Own Data Analysis 

Choose your own additional spatial dataset and conduct a supplementary analysis.

### Challenge Options

Choose ONE of the following challenge exercises, or propose your own research question using OpenDataPhilly data (https://opendataphilly.org/datasets/). 

**Note these are just loose suggestions to spark ideas - follow or make your own as the data permits and as your ideas evolve. This analysis should include bringing in your own dataset, ensuring the projection/CRS of your layers align and are appropriate for the analysis (not lat/long or geodetic coordinate systems). The analysis portion should include some combination of spatial and attribute operations to answer a relatively straightforward question**

---

#### Education & Youth Services

**Option A: Educational Desert Analysis**
- **Data:** Schools, Libraries, Recreation Centers, Census tracts (child population)
- **Question:** "Which neighborhoods lack adequate educational infrastructure for children?"
- **Operations:** Buffer schools/libraries (0.5 mile walking distance), identify coverage gaps, overlay with child population density
- **Policy relevance:** School district planning, library placement, after-school program siting

**Option B: School Safety Zones**
- **Data:** Schools, Crime Incidents, Bike Network
- **Question:** "Are school zones safe for walking/biking, or are they crime hotspots?"
- **Operations:** Buffer schools (1000ft safety zone), spatial join with crime incidents, assess bike infrastructure coverage
- **Policy relevance:** Safe Routes to School programs, crossing guard placement

---

#### Environmental Justice

**Option C: Green Space Equity** 
- **Data:** Parks, Street Trees, Census tracts (race/income demographics)
- **Question:** "Do low-income and minority neighborhoods have equitable access to green space?"
- **Operations:** Buffer parks (10-minute walk = 0.5 mile), calculate tree canopy or park acreage per capita, compare by demographics
- **Policy relevance:** Climate resilience, environmental justice, urban forestry investment
---

#### Public Safety & Justice

**Option D: Crime & Community Resources**
- **Data:** Crime Incidents, Recreation Centers, Libraries, Street Lights
- **Question:** "Are high-crime areas underserved by community resources?"
- **Operations:** Aggregate crime counts to census tracts or neighborhoods, count community resources per area, spatial correlation analysis
- **Policy relevance:** Community investment, violence prevention strategies
---

#### Infrastructure & Services

**Option E: Polling Place Accessibility**
- **Data:** Polling Places, SEPTA stops, Census tracts (elderly population, disability rates)
- **Question:** "Are polling places accessible for elderly and disabled voters?"
- **Operations:** Buffer polling places and transit stops, identify vulnerable populations, find areas lacking access
- **Policy relevance:** Voting rights, election infrastructure, ADA compliance

---

#### Health & Wellness

**Option F: Recreation & Population Health**
- **Data:** Recreation Centers, Playgrounds, Parks, Census tracts (demographics)
- **Question:** "Is lack of recreation access associated with vulnerable populations?"
- **Operations:** Calculate recreation facilities per capita by neighborhood, buffer facilities for walking access, overlay with demographic indicators
- **Policy relevance:** Public health investment, recreation programming, obesity prevention

---

#### Emergency Services

**Option G: EMS Response Coverage**
- **Data:** Fire Stations, EMS stations, Population density, High-rise buildings
- **Question:** "Are population-dense areas adequately covered by emergency services?"
- **Operations:** Create service area buffers (5-minute drive = ~2 miles), assess population coverage, identify gaps in high-density areas
- **Policy relevance:** Emergency preparedness, station siting decisions

---

#### Arts & Culture

**Option H: Cultural Asset Distribution**
- **Data:** Public Art, Museums, Historic sites/markers, Neighborhoods
- **Question:** "Do all neighborhoods have equitable access to cultural amenities?"
- **Operations:** Count cultural assets per neighborhood, normalize by population, compare distribution across demographic groups
- **Policy relevance:** Cultural equity, tourism, quality of life, neighborhood identity

---

### Data Sources

**OpenDataPhilly:** https://opendataphilly.org/datasets/
- Most datasets available as GeoJSON, Shapefile, or CSV with coordinates
- Always check the Metadata for a data dictionary of the fields.

**Additional Sources:**
- **Pennsylvania Open Data:** https://data.pa.gov/
- **Census Bureau (via tidycensus):** Demographics, economic indicators, commute patterns
- **TIGER/Line (via tigris):** Geographic boundaries

### Recommended Starting Points

**If you're feeling confident:** Choose an advanced challenge with multiple data layers. 
**If you are a beginner, choose something more manageable that helps you understand the basics**


**If you have a different idea:** Propose your own question! Just make sure:
- You can access the spatial data
- You can perform at least 2 spatial operations

### Your Analysis

**Your Task:**

1. **Find and load additional data**
   - Document your data source
   - Check and standardize the CRS
   - Provide basic summary statistics

```{r}
# Load your additional dataset




```

**Questions to answer:**
- What dataset did you choose and why?
- What is the data source and date?
- How many features does it contain?
- What CRS is it in? Did you need to transform it?

---

2. **Pose a research question**

Write a clear research statement that your analysis will answer.

**Examples:**
- "Do vulnerable tracts have adequate public transit access to hospitals?"
- "Are EMS stations appropriately located near vulnerable populations?"
- "Do areas with low vehicle access have worse hospital access?"

---

3. **Conduct spatial analysis**

Use at least TWO spatial operations to answer your research question.

**Required operations (choose 2+):**
- Buffers
- Spatial joins
- Spatial filtering with predicates
- Distance calculations
- Intersections or unions
- Point-in-polygon aggregation

**Your Task:**
```{r}
# Your spatial analysis










```

**Analysis requirements:**
- Clear code comments explaining each step
- Appropriate CRS transformations
- Summary statistics or counts
- At least one map showing your findings
- Brief interpretation of results (3-5 sentences)

**Your interpretation:**

[Write your findings here]


## Finally - A few comments about your incorporation of feedback!
Take a few moments to clean up your markdown document and then write a line or two or three about how you may have incorporated feedback that you recieved after your first assignment. 

---

## Submission Requirements

**What to submit:**

1. **Rendered HTML document posted to your course portfolio** with all code, outputs, maps, and text
   - Use `embed-resources: true` in YAML so it's a single file
   - All code should run without errors
   - All maps and charts should display correctly

**File naming:** `LastName_FirstName_Assignment2.html` and `LastName_FirstName_Assignment2.qmd`

---

