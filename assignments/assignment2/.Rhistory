# 6.2 Q-Q plot (normality of residuals)
qqnorm(resid(model_inter_fe), main = "Q-Q Plot of Residuals")
qqline(resid(model_inter_fe), col = 2, lwd = 2)
# 6.3 Scale-Location (residual spread vs fitted — variance stabilization)
plot(model_inter_fe, which = 3)  # Scale-Location built-in plot
# 6.4 Cook's distance (influential observations)
n <- nrow(model_data_cv)
cook <- cooks.distance(model_inter_fe)
thr <- 4 / n  # common rule of thumb
# Basic summary
cat("Cook's D threshold (4/n):", round(thr, 6), "\n")
cat("Number of points above threshold:", sum(cook > thr), "\n")
# Plot Cook's D with threshold
plot(cook, type = "h", col = "gray40",
main = "Cook's Distance", ylab = "Cook's D")
abline(h = thr, col = 2, lty = 2)
# Optionally list top-10 influential indices
head(order(cook, decreasing = TRUE), 10)
# 6.5 (Optional) Heteroskedasticity test (Breusch–Pagan)
if (!requireNamespace("lmtest", quietly = TRUE)) install.packages("lmtest")
library(lmtest)
bptest(model_inter_fe)
# 6.6 (Optional) Multicollinearity check (VIF)
if (!requireNamespace("car", quietly = TRUE)) install.packages("car")
library(car)
vif_vals_diag <- car::vif(model_inter_fe)
sort(vif_vals_diag, decreasing = TRUE)[1:10]
#| label: step1-data-loading
# Load required packages
library(tidyverse)
library(sf)
library(tigris)
library(tidycensus)
options(tigris_use_cache = TRUE, tigris_class = "sf")
data_dir <- "D:/pen/MUSA5080PublicPolicyAnalytics/assignment2/week-04_data"
# Load spatial data
# 1) Pennsylvania county boundaries
counties_path <- file.path(data_dir, "Pennsylvania_County_Boundaries.shp")
pa_counties <- st_read(counties_path, quiet = TRUE) |> st_transform(4326)
# 2) Pennsylvania hospitals
hospitals_path <- file.path(data_dir, "hospitals.geojson")
hospitals <- st_read(hospitals_path, quiet = TRUE) |> st_transform(4326)
# 3) Pennsylvania census tracts
acs_year <- 2022
pa_tracts <- tigris::tracts(state = "PA", year = acs_year, cb = TRUE) |> st_transform(4326)
# Check that all data loaded correctly
n_hospitals <- nrow(hospitals)
n_tracts <- nrow(pa_tracts)
crs_county <- st_crs(pa_counties)$input
crs_hosp <- st_crs(hospitals)$input
crs_tract <- st_crs(pa_tracts)$input
list(
hospitals_n = n_hospitals,
tracts_n = n_tracts,
crs = list(
counties = crs_county,
hospitals = crs_hosp,
tracts = crs_tract
)
)
#| label: step2-demographic-data
# Get demographic data from ACS -----------------------------------------
census_api_key("52672d930a0de492f5df5d49a36554782fa8f1ef", install = FALSE)
acs_year <- 2022
vars <- c(
total_pop = "B01003_001",
median_income = "B19013_001",
male_65_over = "B01001_020",
female_65_over = "B01001_044"
)
pa_demo <- get_acs(
geography = "tract",
state = "PA",
year = acs_year,
variables = vars,
geometry = FALSE,
output = "wide"
) |>
mutate(age_65_total = male_65_overE + female_65_overE)
# Join to tract boundaries ----------------------------------------------
pa_tracts_demo <- pa_tracts |>
left_join(pa_demo, by = "GEOID")
# Quick check ------------------------------------------------------------
summary(pa_tracts_demo$median_incomeE)
n_missing <- sum(is.na(pa_tracts_demo$median_incomeE))
median_income <- median(pa_tracts_demo$median_incomeE, na.rm = TRUE)
cat("Missing income data:", n_missing, "tracts\n")
cat("Median income:", scales::dollar(median_income), "\n")
#| label: step3-define-vulnerable
#| message: false
#| warning: false
# === Step 3: Define thresholds (data-driven version) ===
# CRITICAL: Calculate proportion of elderly - use PERCENTAGE not absolute count!
pa_tracts_demo <- pa_tracts_demo |>
dplyr::mutate(pct_elderly = age_65_total / total_popE)
# Use 30th percentile for income (captures lower-income areas)
# Use 75th percentile for elderly PROPORTION (high elderly concentration)
income_threshold  <- quantile(pa_tracts_demo$median_incomeE, probs = 0.30, na.rm = TRUE)
elderly_threshold <- quantile(pa_tracts_demo$pct_elderly,    probs = 0.75, na.rm = TRUE)
# Create vulnerability indicators
pa_vulnerable <- pa_tracts_demo |>
dplyr::mutate(
low_income   = median_incomeE < income_threshold,
high_elderly = pct_elderly > elderly_threshold,
vulnerable   = low_income & high_elderly
)
# Summary statistics
cat("Income threshold (30th percentile):", scales::dollar(income_threshold), "\n")
cat("Elderly % threshold (75th percentile):", scales::percent(elderly_threshold), "\n\n")
# Count vulnerable tracts
vulnerability_summary <- table(pa_vulnerable$vulnerable, useNA = "ifany")
print(vulnerability_summary)
n_vulnerable <- sum(pa_vulnerable$vulnerable, na.rm = TRUE)
pct_vulnerable <- n_vulnerable / nrow(pa_tracts_demo) * 100
cat("\nVulnerable tracts:", n_vulnerable, "\n")
cat("Percentage of all PA tracts:", round(pct_vulnerable, 2), "%\n")
#| label: step4-distance-calculation
# === Step 4: Calculate Distance to Hospitals ===
# Transform to appropriate projected CRS for Pennsylvania (NAD83 / UTM zone 18N)
pa_vulnerable_proj <- st_transform(pa_vulnerable, 26918)
hospitals_proj     <- st_transform(hospitals, 26918)
# Compute tract centroids
tract_centroids <- st_centroid(pa_vulnerable_proj)
# Compute distance matrix (in meters)
dist_m <- st_distance(tract_centroids, hospitals_proj)
# Find nearest hospital distance (meters) and convert to miles
nearest_m  <- apply(dist_m, 1, min)
nearest_mi <- as.numeric(nearest_m) / 1609.344
# Add to dataframe
pa_vulnerable_proj <- pa_vulnerable_proj |>
dplyr::mutate(dist_to_hospital_mi = nearest_mi)
# Quick summary for VULNERABLE tracts only
vulnerable_distances <- pa_vulnerable_proj |>
filter(vulnerable == TRUE) |>
st_drop_geometry()
avg_dist <- mean(vulnerable_distances$dist_to_hospital_mi, na.rm = TRUE)
max_dist <- max(vulnerable_distances$dist_to_hospital_mi, na.rm = TRUE)
n_far <- sum(vulnerable_distances$dist_to_hospital_mi > 15, na.rm = TRUE)
cat("Statistics for VULNERABLE tracts only:\n")
cat("Average distance:", round(avg_dist, 2), "miles\n")
cat("Maximum distance:", round(max_dist, 2), "miles\n")
cat("Tracts >15 miles away:", n_far, "\n")
#| label: step5-underserved
#| message: false
#| warning: false
# Define underserved tracts (must be BOTH vulnerable AND far from hospital)
pa_vulnerable_proj <- pa_vulnerable_proj |>
dplyr::mutate(
underserved = vulnerable & (dist_to_hospital_mi > 15)
)
# Summary statistics
summary_underserved <- pa_vulnerable_proj |>
st_drop_geometry() |>
filter(vulnerable == TRUE) |>  # Only look at vulnerable tracts
summarise(
total_vulnerable = n(),
underserved_n = sum(underserved, na.rm = TRUE),
underserved_pct = (underserved_n / total_vulnerable) * 100,
avg_distance_mi = mean(dist_to_hospital_mi, na.rm = TRUE),
max_distance_mi = max(dist_to_hospital_mi, na.rm = TRUE)
)
print(summary_underserved)
# Also show the distribution
cat("\nUnderserved tract breakdown:\n")
underserved_table <- table(
Vulnerable = pa_vulnerable_proj$vulnerable,
Underserved = pa_vulnerable_proj$underserved
)
print(underserved_table)
#| label: step6-county-aggregation
# Transform counties to match projection
pa_counties_proj <- st_transform(pa_counties, 26918)
# Spatial join: associate each tract with its county
tracts_with_county <- st_join(pa_vulnerable_proj,
pa_counties_proj |> select(COUNTY_NAM),
join = st_within)
# Aggregate statistics by county (only for vulnerable tracts)
county_summary <- tracts_with_county |>
st_drop_geometry() |>
filter(vulnerable == TRUE) |>
group_by(COUNTY_NAM) |>
summarise(
n_vulnerable_tracts = n(),
n_underserved_tracts = sum(underserved, na.rm = TRUE),
pct_underserved = (n_underserved_tracts / n_vulnerable_tracts) * 100,
avg_distance_mi = mean(dist_to_hospital_mi, na.rm = TRUE),
total_vulnerable_pop = sum(total_popE, na.rm = TRUE),
.groups = "drop"
) |>
arrange(desc(pct_underserved))
# Display top counties
cat("Top 10 counties by percentage underserved:\n")
print(head(county_summary, 10), n = 10)
# Join back to county geometries for mapping
pa_counties_analysis <- pa_counties_proj |>
left_join(county_summary, by = "COUNTY_NAM")
#| label: step7-summary-table
library(knitr)
# Create priority table (sorted by percentage underserved)
priority_counties <- county_summary |>
arrange(desc(pct_underserved)) |>
head(10) |>
mutate(
pct_underserved = paste0(round(pct_underserved, 1), "%"),
avg_distance_mi = round(avg_distance_mi, 1),
total_vulnerable_pop = scales::comma(total_vulnerable_pop)
) |>
select(
County = COUNTY_NAM,
`Vulnerable Tracts` = n_vulnerable_tracts,
`Underserved Tracts` = n_underserved_tracts,
`% Underserved` = pct_underserved,
`Avg Distance (mi)` = avg_distance_mi,
`Vulnerable Population` = total_vulnerable_pop
)
kable(priority_counties,
caption = "Top 10 Priority Counties for Healthcare Investment (sorted by % underserved)",
align = c("l", "r", "r", "r", "r", "r"))
#| label: map1-county-choropleth
#| fig-width: 10
#| fig-height: 8
library(ggplot2)
library(viridis)
# Transform back to WGS84 for mapping
pa_counties_map <- st_transform(pa_counties_analysis, 4326)
hospitals_map <- st_transform(hospitals, 4326)
# Create choropleth map
ggplot() +
# County fill by percentage underserved
geom_sf(data = pa_counties_map,
aes(fill = pct_underserved),
color = "white",
size = 0.3) +
# Hospital points
geom_sf(data = hospitals_map,
color = "#D32F2F",
size = 0.8,
alpha = 0.6) +
# Color scheme
scale_fill_viridis(
name = "% Vulnerable Tracts\nUnderserved",
option = "plasma",
na.value = "grey90",
breaks = seq(0, 100, 20),
labels = function(x) paste0(x, "%")
) +
# Labels and theme
labs(
title = "Healthcare Access Challenges in Pennsylvania",
subtitle = "Percentage of vulnerable tracts located >15 miles from nearest hospital",
caption = "Data: ACS 2022, PA Hospital Data | Vulnerable = Low Income + High Elderly Population | Red dots = Hospitals"
) +
theme_void() +
theme(
plot.title = element_text(size = 16, face = "bold", hjust = 0.5),
plot.subtitle = element_text(size = 12, hjust = 0.5, margin = margin(b = 10)),
plot.caption = element_text(size = 8, hjust = 0.5, margin = margin(t = 10)),
legend.position = "right",
legend.key.height = unit(1, "cm")
)
#| label: map2-detailed-vulnerability
#| fig-width: 10
#| fig-height: 8
# Transform for mapping
tracts_map <- st_transform(pa_vulnerable_proj, 4326)
counties_outline <- st_transform(pa_counties_proj, 4326)
# Filter to show only vulnerable tracts
vulnerable_for_map <- tracts_map |>
filter(vulnerable == TRUE)
ggplot() +
# All vulnerable tracts colored by underserved status
geom_sf(data = vulnerable_for_map,
aes(fill = underserved),
color = NA) +
# County boundaries for context
geom_sf(data = counties_outline,
fill = NA,
color = "gray30",
size = 0.5) +
# Hospitals
geom_sf(data = hospitals_map,
color = "darkred",
size = 1,
alpha = 0.7,
shape = 3) +  # Plus sign for hospitals
# Color scheme
scale_fill_manual(
name = "Tract Status",
values = c("FALSE" = "#4FC3F7", "TRUE" = "#D32F2F"),
labels = c("FALSE" = "Vulnerable (< 15 mi to hospital)",
"TRUE" = "Underserved (≥ 15 mi to hospital)"),
na.value = "transparent"
) +
# Labels
labs(
title = "Underserved Vulnerable Populations in Pennsylvania",
subtitle = "Census tracts with low income, high elderly population, and poor hospital access",
caption = "Blue = Vulnerable but accessible | Red = Vulnerable and underserved | + = Hospital"
) +
theme_void() +
theme(
plot.title = element_text(size = 16, face = "bold", hjust = 0.5),
plot.subtitle = element_text(size = 11, hjust = 0.5, margin = margin(b = 10)),
plot.caption = element_text(size = 8, hjust = 0.5, margin = margin(t = 10)),
legend.position = "bottom",
legend.box = "horizontal"
)
#| label: chart-distribution
#| fig-width: 10
#| fig-height: 6
# Prepare data - only vulnerable tracts
distance_data <- pa_vulnerable_proj |>
st_drop_geometry() |>
filter(vulnerable == TRUE)
# Create histogram with underserved threshold
ggplot(distance_data, aes(x = dist_to_hospital_mi)) +
geom_histogram(binwidth = 2, fill = "#4A90E2", color = "white", alpha = 0.8) +
geom_vline(xintercept = 15,
color = "#D32F2F",
linetype = "dashed",
size = 1.2) +
annotate("text",
x = 15,
y = Inf,
label = "15-mile threshold\n(underserved beyond this point)",
vjust = 2,
hjust = -0.05,
color = "#D32F2F",
size = 3.5,
fontface = "bold") +
labs(
title = "Distribution of Hospital Access for Vulnerable Populations",
subtitle = "Distance from census tract centroid to nearest hospital",
x = "Distance to Nearest Hospital (miles)",
y = "Number of Vulnerable Tracts",
caption = "Tracts beyond 15 miles are considered underserved and face significant barriers to healthcare access"
) +
theme_minimal() +
theme(
plot.title = element_text(size = 14, face = "bold"),
plot.subtitle = element_text(size = 11, margin = margin(b = 10)),
plot.caption = element_text(size = 9, hjust = 0),
panel.grid.minor = element_blank()
)
# Summary interpretation
dist_stats <- distance_data |>
summarise(
median_dist = median(dist_to_hospital_mi, na.rm = TRUE),
mean_dist = mean(dist_to_hospital_mi, na.rm = TRUE),
pct_beyond_15 = mean(dist_to_hospital_mi > 15, na.rm = TRUE) * 100
)
cat("\nKey Statistics:\n")
cat("Median distance:", round(dist_stats$median_dist, 1), "miles\n")
cat("Mean distance:", round(dist_stats$mean_dist, 1), "miles\n")
cat("% beyond 15 miles:", round(dist_stats$pct_beyond_15, 1), "%\n")
#| label: part3-load-library-data
# For this analysis, we'll use Pennsylvania library data
# NOTE: In actual implementation, download from OpenDataPhilly or PA Open Data
# Example sources:
# - OpenDataPhilly: https://opendataphilly.org/datasets/libraries/
# - PA Open Data: https://data.pa.gov/
# Create simulated library locations for demonstration
# REPLACE THIS with actual library data in your final submission
set.seed(42)
pa_counties_centers <- pa_counties_proj |>
st_centroid() |>
st_transform(4326)
# Add some random variation to create "library" points
# This simulates libraries in county seats and towns
library_locations <- pa_counties_centers |>
st_coordinates() |>
as.data.frame() |>
slice(rep(1:n(), each = 2)) |>
mutate(
X = X + rnorm(n(), 0, 0.1),
Y = Y + rnorm(n(), 0, 0.1),
library_id = row_number(),
library_name = paste("Library", library_id)
)
pa_libraries <- st_as_sf(library_locations,
coords = c("X", "Y"),
crs = 4326)
# Summary
cat("Dataset: Pennsylvania Public Libraries (SIMULATED FOR DEMO)\n")
cat("Number of library locations:", nrow(pa_libraries), "\n")
cat("CRS:", st_crs(pa_libraries)$input, "\n")
cat("\nNote: Replace with actual library data from OpenDataPhilly for final submission\n")
#| label: part3-spatial-analysis
# Transform to projected CRS for accurate distance calculations
pa_libraries_proj <- st_transform(pa_libraries, 26918)
# Get vulnerable tracts
vulnerable_tracts_analysis <- pa_vulnerable_proj |>
filter(vulnerable == TRUE)
# ==== SPATIAL OPERATION 1: Distance Calculation ====
# Calculate distance from each vulnerable tract to nearest library
# Get centroids
vulnerable_centroids <- st_centroid(vulnerable_tracts_analysis)
# Calculate distance matrix (vulnerable tracts to libraries)
library_dist_m <- st_distance(vulnerable_centroids, pa_libraries_proj)
# Find nearest library distance
nearest_library_m <- apply(library_dist_m, 1, min)
nearest_library_mi <- as.numeric(nearest_library_m) / 1609.344
# Add to vulnerable tracts data
vulnerable_library_access <- vulnerable_tracts_analysis |>
mutate(
dist_to_library_mi = nearest_library_mi,
library_accessible = dist_to_library_mi <= 10  # 10 miles = reasonable driving distance
)
# ==== SPATIAL OPERATION 2: Buffer Analysis ====
# Create service area buffers around libraries (5-mile buffer = 10-minute drive)
library_buffers <- st_buffer(pa_libraries_proj, dist = 5 * 1609.344)  # 5 miles in meters
# Spatial join: which vulnerable tracts are within 5 miles of a library?
tracts_in_buffer <- st_join(
vulnerable_tracts_analysis,
library_buffers,
join = st_intersects,
left = TRUE
)
# Count how many tracts are within service area
tracts_with_library_access <- tracts_in_buffer |>
st_drop_geometry() |>
summarise(
n_total = n(),
n_in_buffer = sum(!is.na(library_id)),
pct_in_buffer = (n_in_buffer / n_total) * 100
)
# ==== Summary Statistics ====
coverage_summary <- vulnerable_library_access |>
st_drop_geometry() |>
summarise(
total_vulnerable = n(),
within_10mi = sum(library_accessible, na.rm = TRUE),
beyond_10mi = sum(!library_accessible, na.rm = TRUE),
pct_covered = (within_10mi / total_vulnerable) * 100,
avg_distance = mean(dist_to_library_mi, na.rm = TRUE),
median_distance = median(dist_to_library_mi, na.rm = TRUE),
max_distance = max(dist_to_library_mi, na.rm = TRUE)
)
cat("===== Library Access Summary =====\n")
print(coverage_summary)
# Compare library access vs hospital access
access_comparison <- vulnerable_library_access |>
st_drop_geometry() |>
mutate(
hospital_accessible = dist_to_hospital_mi <= 15,
both_accessible = library_accessible & hospital_accessible,
neither_accessible = !library_accessible & !hospital_accessible,
hospital_only = !library_accessible & hospital_accessible,
library_only = library_accessible & !hospital_accessible
) |>
summarise(
both = sum(both_accessible, na.rm = TRUE),
neither = sum(neither_accessible, na.rm = TRUE),
hospital_only = sum(hospital_only, na.rm = TRUE),
library_only = sum(library_only, na.rm = TRUE)
)
cat("\n===== Access Comparison (Hospital vs Library) =====\n")
cat("Both accessible:", access_comparison$both, "tracts\n")
cat("Neither accessible:", access_comparison$neither, "tracts\n")
cat("Hospital only:", access_comparison$hospital_only, "tracts\n")
cat("Library only:", access_comparison$library_only, "tracts\n")
#| label: part3-map
#| fig-width: 10
#| fig-height: 8
# Transform for mapping
vulnerable_library_map <- st_transform(vulnerable_library_access, 4326)
libraries_map <- st_transform(pa_libraries_proj, 4326)
buffers_map <- st_transform(library_buffers, 4326)
# Create map
ggplot() +
# Library service areas (5-mile buffers)
geom_sf(data = buffers_map,
fill = "#81C784",
alpha = 0.15,
color = "#388E3C",
size = 0.2,
linetype = "dashed") +
# Vulnerable tracts by library accessibility
geom_sf(data = vulnerable_library_map,
aes(fill = library_accessible),
color = NA,
alpha = 0.7) +
# County boundaries
geom_sf(data = st_transform(pa_counties_proj, 4326),
fill = NA,
color = "gray40",
size = 0.4) +
# Library locations
geom_sf(data = libraries_map,
color = "#1B5E20",
size = 2.5,
shape = 17) +  # Triangle for libraries
# Color scheme
scale_fill_manual(
name = "Library Access for\nVulnerable Tracts",
values = c("TRUE" = "#A5D6A7", "FALSE" = "#EF5350"),
labels = c("TRUE" = "Within 10 miles", "FALSE" = "Beyond 10 miles")
) +
# Labels
labs(
title = "Library Access for Vulnerable Populations in Pennsylvania",
subtitle = "Public libraries as health information resources and telehealth access points",
caption = "Green circles = 5-mile library service areas | Triangles = Library locations | Analysis focuses on vulnerable tracts only"
) +
theme_void() +
theme(
plot.title = element_text(size = 15, face = "bold", hjust = 0.5),
plot.subtitle = element_text(size = 11, hjust = 0.5, margin = margin(b = 10)),
plot.caption = element_text(size = 8, hjust = 0.5, margin = margin(t = 10)),
legend.position = "right",
legend.text = element_text(size = 9)
)
