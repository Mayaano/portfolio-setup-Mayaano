"cpi",
"Median amount among those with",
"% housing-cost burdened, low-income",
"% with home foreclosure",
"% unbanked, metro area",
"% received EITC, low-income",
"Labor force participation rate",
"% below 200% of federal poverty level",
"Gini index of income inequality"
)
# Keep only complete cases
train_df_clean <- train_df %>%
filter(if_all(all_of(model_vars), ~ !is.na(.)))
test_df_clean <- test_df %>%
filter(if_all(all_of(model_vars), ~ !is.na(.)))
# Fit Model on Training Data
eviction_model_train <- lm(
percentage_diff ~
l1_percentage_diff +
unemployment_rate +
cpi +
`Median amount among those with` +
`% housing-cost burdened, low-income` +
`% with home foreclosure` +
`% unbanked, metro area` +
`% received EITC, low-income` +
`Labor force participation rate` +
`% below 200% of federal poverty level` +
`Gini index of income inequality`,
data = train_df_clean
)
# Out-of-Sample Validation - Test Set
# Predict on test set
test_predictions <- predict(
eviction_model_train,
newdata = test_df_clean
)
# Residuals
test_residuals <- test_df_clean$percentage_diff - test_predictions
# MAE
mae_test <- mean(abs(test_residuals))
# RMSE
rmse_test <- sqrt(mean(test_residuals^2))
# Output
cat("Out-of-Sample Model Performance:\n")
cat("MAE  =", round(mae_test, 4), "\n")
cat("RMSE =", round(rmse_test, 4), "\n")
# Prepare error data for comparison
# In-sample errors
in_sample_errors <- data.frame(
residual = eviction_model$residuals,
sample_type = "In-sample"
)
# Out-of-sample errors
out_sample_errors <- data.frame(
residual = test_residuals,
sample_type = "Out-of-sample"
)
# Combine
error_compare_df <- rbind(in_sample_errors, out_sample_errors)
# Plot
ggplot(error_compare_df, aes(x = residual, fill = sample_type)) +
geom_histogram(
alpha = 0.6,
bins = 30,
position = "identity"
) +
facet_wrap(~ sample_type, scales = "free_y") +
labs(
title = "Comparison of Prediction Errors",
subtitle = "In-sample vs Out-of-sample Residual Distributions",
x = "Prediction Error (Residual)",
y = "Count"
) +
theme_minimal()
library(spdep)
# Prepare spatial neighbors from evictions_geo
nb <- poly2nb(evictions_geo, queen = TRUE)
lw <- nb2listw(nb, style = "W", zero.policy = TRUE)
# Get residuals from model
residuals_vec <- eviction_model$residuals
# Add residuals to evictions_geo
evictions_geo$model_residual <- NA
evictions_geo$model_residual[1:length(residuals_vec)] <- residuals_vec
# Moran's I test with zero.policy = TRUE
moran_result <- moran.test(evictions_geo$model_residual, lw, zero.policy = TRUE, na.action = na.omit)
# Print results
cat("Moran's I Test on Model Residuals\n")
cat("===================================\n")
cat("Moran's I statistic:", round(moran_result$statistic, 4), "\n")
cat("P-value:", round(moran_result$p.value, 4), "\n")
cat("Expected I (under null):", round(moran_result$estimate[2], 4), "\n")
#| include: false
# Load required packages
library(tidycensus)
library(tidyverse)
library(knitr)
library(kableExtra)
library(scales)
# Set Census API key
census_api_key(Sys.getenv("CENSUS_API_KEY"), install = FALSE)
# Choose state
my_state <- "PA"
# Get county-level data
county_data <- get_acs(
geography = "county",
state = my_state,
variables = c(
median_income = "B19013_001",
total_pop = "B01003_001"
),
year = 2022,
survey = "acs5",
output = "wide"
)
# Clean county names
county_data <- county_data %>%
mutate(
county_name = str_remove(NAME, ", Pennsylvania"),
county_name = str_remove(county_name, " County")
)
# Display first few rows
head(county_data) %>%
select(county_name, median_incomeE, median_incomeM, total_popE, total_popM) %>%
kable(
col.names = c("County", "Median Income", "Income MOE", "Population", "Pop MOE"),
format.args = list(big.mark = ","),
caption = "Sample of Pennsylvania County Data (2022 ACS 5-Year Estimates)"
) %>%
kable_styling(bootstrap_options = c("striped", "hover"))
# Calculate MOE percentages and create reliability categories
county_reliability <- county_data %>%
mutate(
moe_pct = (median_incomeM / median_incomeE) * 100,
reliability = case_when(
moe_pct < 5 ~ "High Confidence",
moe_pct >= 5 & moe_pct < 10 ~ "Moderate Confidence",
moe_pct >= 10 ~ "Low Confidence"
),
reliability = factor(reliability,
levels = c("High Confidence", "Moderate Confidence", "Low Confidence")),
unreliable = moe_pct > 10
)
# Summary of reliability categories
reliability_summary <- county_reliability %>%
count(reliability) %>%
mutate(percentage = round((n / sum(n)) * 100, 1))
reliability_summary %>%
kable(
col.names = c("Reliability Category", "Number of Counties", "Percentage"),
caption = "Distribution of Data Reliability Across Pennsylvania Counties"
) %>%
kable_styling(bootstrap_options = c("striped", "hover"))
# Identify top 5 counties with highest MOE
high_moe_counties <- county_reliability %>%
arrange(desc(moe_pct)) %>%
slice(1:5) %>%
select(county_name, median_incomeE, median_incomeM, moe_pct, reliability)
high_moe_counties %>%
kable(
col.names = c("County", "Median Income", "Margin of Error", "MOE %", "Reliability"),
format.args = list(big.mark = ","),
digits = c(0, 0, 0, 2, 0),
caption = "Top 5 Pennsylvania Counties with Highest Data Uncertainty"
) %>%
kable_styling(bootstrap_options = c("striped", "hover"))
# Select counties representing different reliability levels
selected_counties <- county_reliability %>%
filter(
county_name %in% c("Philadelphia", "Centre", "Forest")
) %>%
select(county_name, GEOID, median_incomeE, moe_pct, reliability, total_popE) %>%
arrange(desc(total_popE))
selected_counties %>%
kable(
col.names = c("County", "GEOID", "Median Income", "MOE %", "Reliability", "Population"),
format.args = list(big.mark = ","),
digits = c(0, 0, 0, 2, 0, 0),
caption = "Selected Counties for Detailed Analysis"
) %>%
kable_styling(bootstrap_options = c("striped", "hover"))
# Extract county codes
county_codes <- str_sub(selected_counties$GEOID, 3, 5)
# Get tract-level demographic data
tract_demo <- get_acs(
geography = "tract",
state = my_state,
county = county_codes,
variables = c(
total_pop = "B03002_001",
white = "B03002_003",
black = "B03002_004",
hispanic = "B03002_012"
),
year = 2022,
survey = "acs5",
output = "wide"
)
# Calculate percentages
tract_demo <- tract_demo %>%
mutate(
county_name = case_when(
str_detect(NAME, "Philadelphia") ~ "Philadelphia",
str_detect(NAME, "Centre") ~ "Centre",
str_detect(NAME, "Forest") ~ "Forest"
),
pct_white = (whiteE / total_popE) * 100,
pct_black = (blackE / total_popE) * 100,
pct_hispanic = (hispanicE / total_popE) * 100,
# Calculate MOE percentages
moe_white = (whiteM / whiteE) * 100,
moe_black = (blackM / blackE) * 100,
moe_hispanic = (hispanicM / hispanicE) * 100
)
# Find tract with highest Hispanic percentage
highest_hispanic <- tract_demo %>%
arrange(desc(pct_hispanic)) %>%
slice(1) %>%
select(NAME, county_name, pct_hispanic, hispanicE, hispanicM, moe_hispanic)
highest_hispanic %>%
kable(
col.names = c("Census Tract", "County", "% Hispanic", "Hispanic Pop", "MOE", "MOE %"),
digits = c(0, 0, 1, 0, 0, 1),
caption = "Census Tract with Highest Hispanic/Latino Percentage"
) %>%
kable_styling(bootstrap_options = c("striped", "hover"))
# Calculate county-level averages
county_demographics <- tract_demo %>%
group_by(county_name) %>%
summarize(
n_tracts = n(),
avg_pct_white = mean(pct_white, na.rm = TRUE),
avg_pct_black = mean(pct_black, na.rm = TRUE),
avg_pct_hispanic = mean(pct_hispanic, na.rm = TRUE),
.groups = "drop"
)
county_demographics %>%
kable(
col.names = c("County", "Number of Tracts", "Avg % White", "Avg % Black", "Avg % Hispanic"),
digits = c(0, 0, 1, 1, 1),
caption = "Average Demographics by County"
) %>%
kable_styling(bootstrap_options = c("striped", "hover"))
# Flag tracts with high MOE on any demographic variable
tract_demo <- tract_demo %>%
mutate(
high_moe = (moe_white > 15 | moe_black > 15 | moe_hispanic > 15)
)
# Summary statistics
moe_summary <- tract_demo %>%
summarize(
total_tracts = n(),
tracts_with_high_moe = sum(high_moe, na.rm = TRUE),
pct_high_moe = round((tracts_with_high_moe / total_tracts) * 100, 1)
)
cat("Total tracts analyzed:", moe_summary$total_tracts, "\n")
cat("Tracts with high MOE (>15%) on any demographic variable:",
moe_summary$tracts_with_high_moe,
"(", moe_summary$pct_high_moe, "%)\n")
# Compare characteristics of tracts with/without data quality issues
pattern_analysis <- tract_demo %>%
group_by(high_moe) %>%
summarize(
n_tracts = n(),
avg_population = mean(total_popE, na.rm = TRUE),
avg_pct_white = mean(pct_white, na.rm = TRUE),
avg_pct_black = mean(pct_black, na.rm = TRUE),
avg_pct_hispanic = mean(pct_hispanic, na.rm = TRUE),
.groups = "drop"
) %>%
mutate(
high_moe = ifelse(high_moe, "High MOE (>15%)", "Acceptable MOE (≤15%)")
)
pattern_analysis %>%
kable(
col.names = c("Data Quality", "N Tracts", "Avg Pop", "% White", "% Black", "% Hispanic"),
digits = c(0, 0, 0, 1, 1, 1),
format.args = list(big.mark = ","),
caption = "Comparison of Tract Characteristics by Data Quality"
) %>%
kable_styling(bootstrap_options = c("striped", "hover"))
# Create decision framework
county_recommendations <- county_reliability %>%
mutate(
recommendation = case_when(
reliability == "High Confidence" ~ "Safe for algorithmic decisions",
reliability == "Moderate Confidence" ~ "Use with caution - monitor outcomes",
reliability == "Low Confidence" ~ "Requires manual review or additional data"
)
) %>%
select(county_name, median_incomeE, moe_pct, reliability, recommendation) %>%
arrange(moe_pct)
# Display counties requiring special attention
county_recommendations %>%
filter(reliability %in% c("Moderate Confidence", "Low Confidence")) %>%
kable(
col.names = c("County", "Median Income", "MOE %", "Reliability", "Recommendation"),
format.args = list(big.mark = ","),
digits = c(0, 0, 2, 0, 0),
caption = "Counties Requiring Special Consideration for Algorithm Implementation"
) %>%
kable_styling(bootstrap_options = c("striped", "hover"))
#| include: false
# Load required packages
library(tidycensus)
library(tidyverse)
library(knitr)
library(kableExtra)
library(scales)
# Set Census API key
census_api_key(Sys.getenv("CENSUS_API_KEY"), install = FALSE)
# Choose state
my_state <- "PA"
# Get county-level data
county_data <- get_acs(
geography = "county",
state = my_state,
variables = c(
median_income = "B19013_001",
total_pop = "B01003_001"
),
year = 2022,
survey = "acs5",
output = "wide"
)
# Clean county names
county_data <- county_data %>%
mutate(
county_name = str_remove(NAME, ", Pennsylvania"),
county_name = str_remove(county_name, " County")
)
# Display first few rows
head(county_data) %>%
select(county_name, median_incomeE, median_incomeM, total_popE, total_popM) %>%
kable(
col.names = c("County", "Median Income", "Income MOE", "Population", "Pop MOE"),
format.args = list(big.mark = ","),
caption = "Sample of Pennsylvania County Data (2022 ACS 5-Year Estimates)"
) %>%
kable_styling(bootstrap_options = c("striped", "hover"))
# Calculate MOE percentages and create reliability categories
county_reliability <- county_data %>%
mutate(
moe_pct = (median_incomeM / median_incomeE) * 100,
reliability = case_when(
moe_pct < 5 ~ "High Confidence",
moe_pct >= 5 & moe_pct < 10 ~ "Moderate Confidence",
moe_pct >= 10 ~ "Low Confidence"
),
reliability = factor(reliability,
levels = c("High Confidence", "Moderate Confidence", "Low Confidence")),
unreliable = moe_pct > 10
)
# Summary of reliability categories
reliability_summary <- county_reliability %>%
count(reliability) %>%
mutate(percentage = round((n / sum(n)) * 100, 1))
reliability_summary %>%
kable(
col.names = c("Reliability Category", "Number of Counties", "Percentage"),
caption = "Distribution of Data Reliability Across Pennsylvania Counties"
) %>%
kable_styling(bootstrap_options = c("striped", "hover"))
# Identify top 5 counties with highest MOE
high_moe_counties <- county_reliability %>%
arrange(desc(moe_pct)) %>%
slice(1:5) %>%
select(county_name, median_incomeE, median_incomeM, moe_pct, reliability)
high_moe_counties %>%
kable(
col.names = c("County", "Median Income", "Margin of Error", "MOE %", "Reliability"),
format.args = list(big.mark = ","),
digits = c(0, 0, 0, 2, 0),
caption = "Top 5 Pennsylvania Counties with Highest Data Uncertainty"
) %>%
kable_styling(bootstrap_options = c("striped", "hover"))
# Select counties representing different reliability levels
selected_counties <- county_reliability %>%
filter(
county_name %in% c("Philadelphia", "Centre", "Forest")
) %>%
select(county_name, GEOID, median_incomeE, moe_pct, reliability, total_popE) %>%
arrange(desc(total_popE))
selected_counties %>%
kable(
col.names = c("County", "GEOID", "Median Income", "MOE %", "Reliability", "Population"),
format.args = list(big.mark = ","),
digits = c(0, 0, 0, 2, 0, 0),
caption = "Selected Counties for Detailed Analysis"
) %>%
kable_styling(bootstrap_options = c("striped", "hover"))
# Extract county codes
county_codes <- str_sub(selected_counties$GEOID, 3, 5)
# Get tract-level demographic data
tract_demo <- get_acs(
geography = "tract",
state = my_state,
county = county_codes,
variables = c(
total_pop = "B03002_001",
white = "B03002_003",
black = "B03002_004",
hispanic = "B03002_012"
),
year = 2022,
survey = "acs5",
output = "wide"
)
# Calculate percentages
tract_demo <- tract_demo %>%
mutate(
county_name = case_when(
str_detect(NAME, "Philadelphia") ~ "Philadelphia",
str_detect(NAME, "Centre") ~ "Centre",
str_detect(NAME, "Forest") ~ "Forest"
),
pct_white = (whiteE / total_popE) * 100,
pct_black = (blackE / total_popE) * 100,
pct_hispanic = (hispanicE / total_popE) * 100,
# Calculate MOE percentages
moe_white = (whiteM / whiteE) * 100,
moe_black = (blackM / blackE) * 100,
moe_hispanic = (hispanicM / hispanicE) * 100
)
# Find tract with highest Hispanic percentage
highest_hispanic <- tract_demo %>%
arrange(desc(pct_hispanic)) %>%
slice(1) %>%
select(NAME, county_name, pct_hispanic, hispanicE, hispanicM, moe_hispanic)
highest_hispanic %>%
kable(
col.names = c("Census Tract", "County", "% Hispanic", "Hispanic Pop", "MOE", "MOE %"),
digits = c(0, 0, 1, 0, 0, 1),
caption = "Census Tract with Highest Hispanic/Latino Percentage"
) %>%
kable_styling(bootstrap_options = c("striped", "hover"))
# Calculate county-level averages
county_demographics <- tract_demo %>%
group_by(county_name) %>%
summarize(
n_tracts = n(),
avg_pct_white = mean(pct_white, na.rm = TRUE),
avg_pct_black = mean(pct_black, na.rm = TRUE),
avg_pct_hispanic = mean(pct_hispanic, na.rm = TRUE),
.groups = "drop"
)
county_demographics %>%
kable(
col.names = c("County", "Number of Tracts", "Avg % White", "Avg % Black", "Avg % Hispanic"),
digits = c(0, 0, 1, 1, 1),
caption = "Average Demographics by County"
) %>%
kable_styling(bootstrap_options = c("striped", "hover"))
# Flag tracts with high MOE on any demographic variable
tract_demo <- tract_demo %>%
mutate(
high_moe = (moe_white > 15 | moe_black > 15 | moe_hispanic > 15)
)
# Summary statistics
moe_summary <- tract_demo %>%
summarize(
total_tracts = n(),
tracts_with_high_moe = sum(high_moe, na.rm = TRUE),
pct_high_moe = round((tracts_with_high_moe / total_tracts) * 100, 1)
)
cat("Total tracts analyzed:", moe_summary$total_tracts, "\n")
cat("Tracts with high MOE (>15%) on any demographic variable:",
moe_summary$tracts_with_high_moe,
"(", moe_summary$pct_high_moe, "%)\n")
# Compare characteristics of tracts with/without data quality issues
pattern_analysis <- tract_demo %>%
group_by(high_moe) %>%
summarize(
n_tracts = n(),
avg_population = mean(total_popE, na.rm = TRUE),
avg_pct_white = mean(pct_white, na.rm = TRUE),
avg_pct_black = mean(pct_black, na.rm = TRUE),
avg_pct_hispanic = mean(pct_hispanic, na.rm = TRUE),
.groups = "drop"
) %>%
mutate(
high_moe = ifelse(high_moe, "High MOE (>15%)", "Acceptable MOE (≤15%)")
)
pattern_analysis %>%
kable(
col.names = c("Data Quality", "N Tracts", "Avg Pop", "% White", "% Black", "% Hispanic"),
digits = c(0, 0, 0, 1, 1, 1),
format.args = list(big.mark = ","),
caption = "Comparison of Tract Characteristics by Data Quality"
) %>%
kable_styling(bootstrap_options = c("striped", "hover"))
# Create decision framework
county_recommendations <- county_reliability %>%
mutate(
recommendation = case_when(
reliability == "High Confidence" ~ "Safe for algorithmic decisions",
reliability == "Moderate Confidence" ~ "Use with caution - monitor outcomes",
reliability == "Low Confidence" ~ "Requires manual review or additional data"
)
) %>%
select(county_name, median_incomeE, moe_pct, reliability, recommendation) %>%
arrange(moe_pct)
# Display counties requiring special attention
county_recommendations %>%
filter(reliability %in% c("Moderate Confidence", "Low Confidence")) %>%
kable(
col.names = c("County", "Median Income", "MOE %", "Reliability", "Recommendation"),
format.args = list(big.mark = ","),
digits = c(0, 0, 2, 0, 0),
caption = "Counties Requiring Special Consideration for Algorithm Implementation"
) %>%
kable_styling(bootstrap_options = c("striped", "hover"))
